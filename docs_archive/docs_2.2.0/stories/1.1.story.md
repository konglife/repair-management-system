# Story 1.1: Extend tRPC Endpoint for Additional Data

## Status
DONE

## Story
**As a** developer,
**I want** to enhance the `reports.getMonthlySummary` tRPC endpoint to include product names for sales/repairs and fetch purchase records,
**so that** the front-end has all the necessary data to render the improved report page in a single call.

## Acceptance Criteria
1. The `getMonthlySummary` response for `salesData` must be updated to include a new property, e.g., `saleItems: { name: string }[]`.
2. The response for `repairsData` must be updated to include a new property, e.g., `usedParts: { name: string, costAtTime: number }[]`.
3. The endpoint must fetch and return a new array of `purchaseRecordsData` for the specified date range.
4. The changes must be backward compatible, not breaking the existing structure that the `ReportView` component currently relies on.

## Tasks / Subtasks
- [x] Task 1: Update SalesData interface to include saleItems array (AC: 1)
  - [x] Add `saleItems: { name: string }[]` to SalesData interface
  - [x] Ensure backward compatibility with existing salesData structure
- [x] Task 2: Update RepairsData interface to include usedParts array (AC: 2)  
  - [x] Add `usedParts: { name: string, costAtTime: number }[]` to RepairsData interface
  - [x] Ensure backward compatibility with existing repairsData structure
- [x] Task 3: Add PurchaseRecordDetail interface and update SummaryData (AC: 3)
  - [x] Create PurchaseRecordDetail interface with product name
  - [x] Add purchaseRecordsData array to SummaryData interface
- [x] Task 4: Modify Prisma queries to include product relations (AC: 1, 2, 3)
  - [x] Update sales query to include saleItems with product names
  - [x] Update repairs query to include usedParts with product names and costs
  - [x] Add purchaseRecords query with product names for date range
- [x] Task 5: Transform and return enhanced data (AC: 1, 2, 3, 4)
  - [x] Map sales data to include saleItems with product names
  - [x] Map repairs data to include usedParts with product names and costs  
  - [x] Map purchase records data with product names
  - [x] Verify backward compatibility with existing data structure
- [x] Task 6: Write unit tests for enhanced endpoint
  - [x] Test new interface additions
  - [x] Test Prisma query modifications
  - [x] Test data transformation logic
  - [x] Test backward compatibility

## Dev Notes

### Previous Story Insights
No previous story exists - this is the first story in the epic.

### Data Models
**Relevant Database Schema** [Source: prisma/schema.prisma]:
- **Sale Model**: Has `saleItems` relation to SaleItem[], which relates to Product
- **SaleItem Model**: Contains `quantity`, `priceAtTime`, `costAtTime`, and relates to Product via `productId`
- **Repair Model**: Has `usedParts` relation to UsedPart[], which relates to Product  
- **UsedPart Model**: Contains `quantity`, `costAtTime`, and relates to Product via `productId`
- **PurchaseRecord Model**: Contains `quantity`, `costPerUnit`, `purchaseDate`, and relates to Product via `productId`
- **Product Model**: Contains `name` field needed for display

### API Specifications
**Current tRPC Endpoint Structure** [Source: src/server/api/routers/reports.ts]:
- Endpoint: `reports.getMonthlySummary`
- Input: `{ startDate: string, endDate: string }` (YYYY-MM-DD format)
- Current queries already include product relations for sales and repairs (lines 85-89, 106-110)
- Purchase records query exists but only used for expenses calculation (lines 132-140)

**Required Interface Extensions** [Source: docs/architecture/api-design-and-integration-trpc.md]:
```typescript
interface SaleItemDetail {
  product: { name: string };
}

interface UsedPartDetail {
  quantity: number;
  costAtTime: number;
  product: { name: string };
}

interface PurchaseRecordDetail {
  // existing fields + product: { name: string };
}
```

### Component Specifications
**Current ReportView Component Dependency**: The endpoint currently returns salesData and repairsData arrays that are consumed by ReportView component. Changes must maintain backward compatibility [Source: docs/architecture/enhancement-scope-and-integration-strategy.md].

### File Locations
**Target File Path**: `src/server/api/routers/reports.ts` - Main file to modify
**Project Structure**: Using Next.js App Router with tRPC integration in `/src/server/api/` [Source: project structure analysis]

### Technical Constraints
- **Backward Compatibility**: Output type will be extended but remain backward compatible with existing fields [Source: docs/architecture/enhancement-scope-and-integration-strategy.md]
- **TypeScript**: Must maintain strict typing throughout interface modifications
- **Prisma Relations**: Leverage existing include statements for product relations already in place

### Testing Requirements
**Backend Testing Standards** [Source: docs/architecture/testing-strategy.md]:
- Update existing tests for `reports.ts` to reflect new data structure
- Add unit tests to verify:
  - Presence and correctness of `saleItems` and `usedParts` data
  - Successful fetching and inclusion of `purchaseRecords`  
  - Calculations remain accurate
- Test file location: Follow existing test structure in project

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
No blocking issues encountered during implementation

### Completion Notes List
- Successfully extended SalesData interface with saleItems array containing product names
- Enhanced RepairsData interface with usedParts array including product names and costs
- Created PurchaseRecordDetail interface and added purchaseRecordsData to SummaryData
- Updated Prisma queries to include product relations for complete data fetching
- Implemented data transformation logic maintaining backward compatibility
- Created comprehensive unit tests covering all new functionality and backward compatibility
- Fixed TypeScript error: corrected PurchaseRecordDetail.id type from number to string to match Prisma schema
- All tests pass and TypeScript compilation successful with no errors

### File List
- Modified: `src/server/api/routers/reports.ts` - Enhanced tRPC endpoint with new data structures and queries
- Created: `src/server/api/routers/reports.test.ts` - Comprehensive unit tests for endpoint functionality

## QA Results
*This section will be populated by QA Agent after story completion*