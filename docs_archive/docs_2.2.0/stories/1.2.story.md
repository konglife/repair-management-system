# Story 1.2: Refactor Data Table Components

## Status
DONE

## Story
**As a** developer,
**I want** to refactor the `ReportView` component to support new columns and a summary total row,
**so that** the tables can display richer data and provide clear financial totals.

## refer
[ui-ux-specification](../ui-ux-specification.md)

## Acceptance Criteria
1. The Sales table within `ReportView` correctly renders the new "Sale Items" column.
2. The Repairs table correctly renders the new "Parts Used" column, including product names and costs.
3. A new table for "Purchase Records" is created and correctly displays purchase data.
4. All three tables dynamically calculate and display a "Total" row for any columns containing monetary values.

## Tasks / Subtasks
- [x] Task 1: Refactor ReportView component into smaller sub-components (AC: 1, 2, 3, 4)
  - [x] Extract ReportHeader component for shop info and date range
  - [x] Extract OverviewMetrics component (no changes needed, just extraction)
  - [x] Create SalesTable component with new Sale Items column
  - [x] Create RepairsTable component with new Parts Used column  
  - [x] Create PurchasesTable component for purchase records data
- [x] Task 2: Update TypeScript interfaces to support new data structures (AC: 1, 2, 3)
  - [x] Extend SalesData interface to include saleItems array
  - [x] Extend RepairsData interface to include usedParts array
  - [x] Create PurchaseRecordDetail interface for purchase data
  - [x] Update SummaryData interface to include purchaseData array
- [x] Task 3: Implement table total calculation logic (AC: 4)
  - [x] Add total row calculation for SalesTable monetary columns
  - [x] Add total row calculation for RepairsTable monetary columns
  - [x] Add total row calculation for PurchasesTable monetary columns
  - [x] Ensure totals are dynamically updated when data changes
- [x] Task 4: Update main ReportView to orchestrate new components (AC: 1, 2, 3, 4)
  - [x] Import and use new sub-components
  - [x] Pass appropriate props from enhanced API data
  - [x] Maintain existing layout and styling consistency
  - [x] Ensure backward compatibility with existing data structure
- [x] Task 5: Write component tests for new functionality
  - [x] Test ReportHeader component rendering
  - [x] Test SalesTable with Sale Items column and totals
  - [x] Test RepairsTable with Parts Used column and totals
  - [x] Test PurchasesTable rendering and totals
  - [x] Test integration with main ReportView component

## Dev Notes

### Previous Story Insights
Story 1.1 successfully enhanced the tRPC endpoint to provide:
- `saleItems: { name: string }[]` array in salesData
- `usedParts: { name: string, costAtTime: number }[]` array in repairsData  
- New `purchaseRecordsData` array in the API response
- All changes are backward compatible with existing data structure

### Data Models
**Enhanced API Data Structure** [Source: Story 1.1 completion]:
```typescript
interface SalesData {
  // existing fields: date, totalCost, netTotal, totalAmount, grossProfit
  saleItems: { name: string }[];
}

interface RepairsData {
  // existing fields: date, description, partsCost, laborCost, totalCost
  usedParts: { name: string, costAtTime: number }[];
}

interface PurchaseRecordDetail {
  id: string;
  quantity: number;
  costPerUnit: number;
  purchaseDate: string;
  product: { name: string };
}

interface SummaryData {
  // existing fields: reportPeriod, shopInfo, overview, salesData, repairsData
  purchaseData: PurchaseRecordDetail[];
}
```

### Component Specifications
**Component Refactoring Structure** [Source: docs/architecture/component-architecture.md]:

1. **ReportHeader.tsx** (new component):
   - **Props**: `shopInfo`, `reportPeriod`
   - **Responsibility**: Shop information and report date range display

2. **OverviewMetrics.tsx** (new component):  
   - **Props**: `overview`
   - **Responsibility**: 8 key business metrics in two-column layout

3. **SalesTable.tsx** (new component):
   - **Props**: `salesData` (enhanced with saleItems)
   - **Responsibility**: Sales table with new "Sale Items" column and totals
   - **New Column**: Display comma-separated product names from saleItems array

4. **RepairsTable.tsx** (new component):
   - **Props**: `repairsData` (enhanced with usedParts)  
   - **Responsibility**: Repairs table with "Parts Used" column and totals
   - **New Column**: Display product names and costs from usedParts array

5. **PurchasesTable.tsx** (new component):
   - **Props**: `purchaseData`
   - **Responsibility**: New purchase records table with totals
   - **Columns**: Date, Product Name, Quantity, Cost Per Unit, Total Cost

### File Locations
**Target Component Directory**: `src/components/reports/` [Source: project structure analysis]
- Create: `ReportHeader.tsx`, `OverviewMetrics.tsx`, `SalesTable.tsx`, `RepairsTable.tsx`, `PurchasesTable.tsx`
- Modify: `ReportView.tsx` - refactor to use new sub-components
- Existing utility: Use `formatCurrency` and `formatReportDate` from `~/lib/utils`

### Technical Constraints
- **Backward Compatibility**: Must work with existing data structure from API [Source: docs/architecture/enhancement-scope-and-integration-strategy.md]
- **TypeScript**: Maintain strict typing throughout component interfaces
- **Styling**: Use existing Tailwind CSS classes and maintain consistent table styling patterns
- **State Management**: Keep all state local to `summary/page.tsx` component

### Testing Standards
**Frontend Component Testing** [Source: docs/architecture/testing-strategy.md]:
- **Component Tests**: Create new tests for each sub-component (ReportHeader, OverviewMetrics, SalesTable, RepairsTable, PurchasesTable)
- **Integration Test**: Update existing test for main ReportView component
- **Mock Data**: Use mock data to verify new columns render correctly  
- **Total Calculations**: Verify table footer totals are accurate
- **Test Location**: Follow existing test structure with `.test.tsx` files alongside components

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation | Scrum Master Bob |

## Dev Agent Record
*This section has been populated by the development agent during implementation*

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
N/A - No blocking issues encountered during implementation

### Completion Notes List
- Successfully refactored ReportView component into 5 smaller sub-components (ReportHeader, OverviewMetrics, SalesTable, RepairsTable, PurchasesTable)
- Enhanced TypeScript interfaces to support new data structures with backward compatibility
- Implemented table total calculation logic for all monetary columns in each table
- Created comprehensive test suite with 53 tests covering all components and edge cases
- All new components properly handle enhanced data structures (saleItems, usedParts, purchaseData)
- Maintained existing styling and responsive layout patterns
- Added proper error handling for missing or undefined data properties

### File List
- **Created**: `src/components/reports/types.ts` - Shared TypeScript interfaces
- **Created**: `src/components/reports/ReportHeader.tsx` - Shop info and date range component
- **Created**: `src/components/reports/OverviewMetrics.tsx` - Business metrics grid component
- **Created**: `src/components/reports/SalesTable.tsx` - Enhanced sales table with Sale Items column and totals
- **Created**: `src/components/reports/RepairsTable.tsx` - Enhanced repairs table with Parts Used column and totals
- **Created**: `src/components/reports/PurchasesTable.tsx` - New purchases table with totals
- **Modified**: `src/components/reports/ReportView.tsx` - Refactored to orchestrate sub-components
- **Created**: `src/components/reports/ReportHeader.test.tsx` - Component tests
- **Created**: `src/components/reports/OverviewMetrics.test.tsx` - Component tests
- **Created**: `src/components/reports/SalesTable.test.tsx` - Component tests
- **Created**: `src/components/reports/RepairsTable.test.tsx` - Component tests
- **Created**: `src/components/reports/PurchasesTable.test.tsx` - Component tests
- **Modified**: `src/components/reports/ReportView.test.tsx` - Updated integration tests

## QA Results
*This section will be populated by QA Agent after story completion*