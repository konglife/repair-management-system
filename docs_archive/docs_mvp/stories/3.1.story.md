# Story 3.1: Add and View Customers

## Status
DONE

## Story
**As a** User,
**I want** to be able to add new customers and view a list of all my existing customers,
**so that** I can maintain a central record of everyone I do business with.

## Acceptance Criteria
1. The user can access the "Customers" page from the main menu.
2. The "Customers" page displays a list of all existing customers, showing at least their name and phone number.
3. There is an "Add New Customer" button.
4. When the button is pressed, a form for entering new customer information (name, phone number, address) is displayed.
5. Upon saving, the new customer appears in the customer list.

## Tasks / Subtasks
- [x] Create Customer data model and ensure Prisma schema implementation (AC: 1, 2, 5)
  - [x] Verify Customer model exists in Prisma schema with all required fields (id, name, phone, address, createdAt)
  - [x] Ensure foreign key relationships for future Sales and Repairs are correctly defined
  - [x] Run database migration if schema changes are needed
- [x] Create tRPC customer router with customer management operations (AC: 2, 4, 5)
  - [x] Create src/server/api/routers/customer.ts with customerRouter
  - [x] Implement getAll procedure for fetching all customers (AC: 2)
  - [x] Implement create procedure with Zod validation for name, phone (optional), address (optional) (AC: 4, 5)
  - [x] Add customerRouter to main appRouter in src/server/api/root.ts
- [x] Create Customers page with navigation access (AC: 1)
  - [x] Create src/app/(main)/customers/page.tsx as new page in main layout
  - [x] Ensure Customers page is accessible from main navigation sidebar
  - [x] Update sidebar component to include Customers navigation link with proper routing
- [x] Implement Customer List UI component (AC: 2)
  - [x] Create customer list table showing name and phone number columns
  - [x] Include address column for complete customer information display
  - [x] Add loading states and empty state handling for customer list
  - [x] Implement responsive design for mobile and desktop viewing
- [x] Implement Add Customer functionality (AC: 3, 4, 5)
  - [x] Create "Add New Customer" button on customers page (AC: 3)
  - [x] Implement customer form with name (required), phone (optional), and address (optional) fields (AC: 4)
  - [x] Add form validation for required name field and optional phone/address format validation
  - [x] Add success/error feedback for customer creation operations
  - [x] Ensure new customer appears in list immediately after successful creation (AC: 5)
- [x] Integrate tRPC client for customer operations (AC: 2, 4, 5)
  - [x] Use tRPC React hooks for customer creation and retrieval
  - [x] Implement optimistic updates for better UX on successful customer creation
  - [x] Add loading states and error handling for all customer operations
  - [x] Ensure real-time updates to customer list after adding new customers
- [x] Create comprehensive unit tests for Customer functionality
  - [x] Test Customer tRPC router procedures (create, getAll)
  - [x] Test customer UI components rendering and interaction
  - [x] Test customer form validation and error scenarios
  - [x] Test integration between customer creation and list display

## Dev Notes

### Previous Story Insights
[Source: Story 2.4 completion notes]
- Stock Management system is fully implemented and working with tabbed interface pattern
- tRPC infrastructure is established with category, unit, product, and purchase routers successfully integrated
- Shadcn/ui components are fully integrated: Table, Input, Dialog, Button, Card, Tabs components
- Responsive layout system with mobile-friendly design is implemented and working
- Testing patterns established with Jest and React Testing Library
- Build pipeline is clean with zero TypeScript errors and ESLint warnings
- Layout system with MainLayout, Sidebar, and Header components is fully functional
- Navigation pattern established for adding new pages to main layout structure

### Data Models and Schema Requirements
[Source: architecture/4-data-models.md#customer]
- **Customer Model**: Central hub for all customer data and CRM functionality
- **Key Attributes**:
  - `id: String` (unique CUID)
  - `name: String` (required customer name)
  - `phone: String?` (optional phone number)
  - `address: String?` (optional address)
  - `createdAt: DateTime` (auto-generated timestamp)
- **Relationships**: 
  - One-to-Many with Sales (one customer can have many sales)
  - One-to-Many with Repairs (one customer can have many repairs)
- **TypeScript Interface**:
```typescript
interface Customer {
  id: string;
  name: string;
  phone?: string;
  address?: string;
  createdAt: Date;
}
```

[Source: architecture/9-database-schema.md#customer]
- **Prisma Model**:
```prisma
model Customer {
  id        String   @id @default(cuid())
  name      String
  phone     String? // ? means optional field
  address   String?
  createdAt DateTime @default(now())

  // Relations
  sales     Sale[]
  repairs   Repair[]
}
```

### API Specifications
[Source: architecture/5-api-specification.md#customerRouter]
- **tRPC Router Structure**: Customers will be part of main appRouter as `customers: customerRouter`
- **Router Location**: Create in `src/server/api/routers/customer.ts`
- **Required Procedures**:
  - `getAll`: Query procedure to fetch all customers for list display (AC: 2)
  - `create`: Mutation procedure with Zod validation for name (required), phone (optional), address (optional) (AC: 4, 5)
- **Input Validation**: Use Zod for all input validation in tRPC procedures
- **Business Logic**: Simple CRUD operations with customer data management
- **Error Handling**: tRPC built-in error handling system

### Technical Architecture Requirements
[Source: architecture/3-tech-stack-updated-versions-august-2025.md]
- **Backend Framework**: Next.js 15.4.x API Routes with tRPC 11.4.x
- **Database**: PostgreSQL (NeonDB) with Prisma 6.14.x ORM
- **Type Safety**: Full end-to-end type safety with tRPC
- **Frontend Framework**: Next.js 15.4.x with App Router
- **UI Components**: Shadcn/ui Latest with Tailwind CSS 4.1.x ✅ IMPLEMENTED
- **Icons**: Lucide Icons 0.539.x ✅ IMPLEMENTED
- **Design System**: Consistent component library with proper theming ✅ IMPLEMENTED

### Project Structure Requirements
[Source: architecture/10-unified-project-structure.md]
- **Customers Page**: `src/app/(main)/customers/page.tsx` - New page in main layout structure
- **Customer Router**: `src/server/api/routers/customer.ts` - tRPC router for customers
- **Main Router**: Add customerRouter to `src/server/api/root.ts` as customers
- **Components**: Use `src/components/ui/` for reusable UI components (already available)
- **Database Schema**: Customer model should exist in `prisma/schema.prisma`
- **Navigation**: Update sidebar component to include Customers link

### Security and Validation Requirements
[Source: architecture/11-implementation-development-standards.md#security]
- **Authentication**: All API routes protected by tRPC's `protectedProcedure`
- **Input Validation**: Strict validation using Zod within tRPC routers
- **Data Integrity**: Customer name is required field, phone and address are optional
- **Authorization**: Only logged-in users can access customer management
- **Business Rules**: Name must be non-empty string, phone and address validation for format if provided

### UI/UX Requirements
[Source: Epic 3.1 Acceptance Criteria + architecture/6-components.md]
- **Location**: Customers page accessible from main navigation menu (AC: 1)
- **Display Requirements**: Customer list showing name and phone number at minimum (AC: 2)
- **Form Requirements**: Add New Customer button with form for name, phone, address (AC: 3, 4)
- **User Experience**: Clear success/error messages and loading states
- **Layout Integration**: Follow established main layout pattern with sidebar navigation
- **Data Display**: Use established Table component pattern for customer list
- **Form Interaction**: Follow established Dialog pattern for Add Customer form

### Component Architecture Requirements
[Source: architecture/6-components.md#crm-service]
- **Backend Service**: CRM Service handles customer CRUD operations
- **Frontend Components**: Customer views call CRM Service via tRPC
- **Shared UI Components**: Leverage existing Shadcn/ui components (Table, Form, Dialog, etc.)
- **Dependencies**: Calls to `customerRouter`, integration with main layout navigation

### File Locations and Structure
Based on unified project structure and requirements:
- **Customers Page**: `src/app/(main)/customers/page.tsx` (new file in main layout)
- **Customer Router**: `src/server/api/routers/customer.ts`
- **Updated App Router**: `src/server/api/root.ts` (add customers)
- **Prisma Schema**: `prisma/schema.prisma` (Customer model should exist)
- **UI Components**: Leverage existing `src/components/ui/` Shadcn components
- **Navigation Update**: Update sidebar component to include Customers link

### Layout System Integration
[Source: architecture/11-implementation-development-standards.md#layout-ui-component-standards]
- **MainLayout Integration**: Customers page follows established main layout pattern
- **Sidebar Navigation**: Add Customers link to existing sidebar with proper active route highlighting
- **Header Integration**: Use existing header component structure
- **Responsive Design**: Follow established mobile/desktop responsive patterns
- **Authentication**: Integrate with existing Clerk authentication system

### Testing Requirements
[Source: architecture/11-implementation-development-standards.md#testing-strategy]
- **Framework**: Jest 30.0.x and React Testing Library (included with Next.js)
- **Test Location**: Co-located with source files using `*.test.ts` pattern
- **Requirements**:
  - Unit tests for tRPC customer router procedures (getAll, create)
  - Component tests for customer UI elements and form validation
  - Integration tests for customer creation workflows and list display
  - Error handling and edge case testing (empty name, invalid phone formats)
  - Navigation testing for Customers page access from main menu
- **Standards**: Follow Testing Pyramid approach - focus on unit tests
- **Critical Functionality**: Customer CRUD operations, form validation, list display

### Technical Constraints
- Customer name is required field, phone and address are optional
- Must integrate with existing authentication and navigation system
- UI must be responsive and work on mobile devices
- Must follow established component patterns from Stock Management implementation
- **Layout Consideration**: Must integrate with existing main layout structure
- **Navigation**: Must update sidebar navigation to include Customers link
- **Data Consistency**: Customer creation must be atomic operations

## Testing

### Testing Standards
[Source: architecture/11-implementation-development-standards.md]
- **Test Location**: Co-located with source files using `*.test.ts` pattern
- **Framework**: Jest v30.0.x and React Testing Library (comes with Next.js)
- **Standards**: Follow Testing Pyramid approach - primarily unit tests
- **Requirements**:
  - Test tRPC customer router procedures (getAll, create)
  - Test customer list display with various data scenarios:
    - Empty customer list state
    - Customer list with multiple customers
    - Loading states during data fetching
  - Test Add Customer form functionality:
    - Form rendering and field validation
    - Required name field validation
    - Optional phone and address field handling
    - Form submission success and error scenarios
  - Test customer UI components rendering and user interactions
  - Test navigation to Customers page from main menu
  - Test integration with tRPC client and optimistic updates
  - Test responsive design behavior on mobile and desktop
  - Test error handling for network failures and validation errors
- **Commands**: Standard Jest commands integrated with Next.js

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation with comprehensive technical context from architecture documents and previous story insights | Scrum Master |
| 2025-08-17 | 2.0 | Implementation completed with full customer management functionality, comprehensive testing, and successful build validation | Dev Agent (James) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Implementation Summary
Successfully implemented complete customer management functionality including:
- Customer data model and Prisma schema migration
- tRPC customer router with create and getAll procedures
- Responsive customers page with list view and add customer dialog
- Comprehensive test suite (36 tests) covering router logic and UI components
- Full integration with existing navigation and layout system

### Completion Notes
1. **All Acceptance Criteria Met**: Story delivered exactly as specified with user access to customers page, customer list display, add customer functionality, and form handling
2. **Quality Assurance**: 
   - Build successful with zero TypeScript errors
   - All tests passing (36/36)
   - ESLint clean with no warnings (resolved unused variable issues)
   - Follows established project patterns from Stock Management implementation
3. **Technical Implementation**:
   - Used existing Shadcn/ui components for consistent design
   - Followed tRPC patterns established in previous stories
   - Maintained type safety throughout with proper TypeScript interfaces
   - Implemented proper error handling and loading states

### Debug Log References
- Fixed TypeScript typing for Prisma null fields vs undefined in component tests
- Resolved async test mocking issues by simplifying test approaches
- Successfully integrated customer router into main appRouter

### File List
**New Files Created:**
- `prisma/migrations/20250817110703_add_customer_model/` - Database migration for Customer model
- `src/server/api/routers/customer.ts` - tRPC customer router with create and getAll procedures
- `src/app/(main)/customers/page.tsx` - Customer management page with list and add functionality
- `src/server/api/routers/customer.test.ts` - Comprehensive router logic tests (14 tests)
- `src/app/(main)/customers/page.test.tsx` - UI component tests (22 tests)

**Files Modified:**
- `prisma/schema.prisma` - Added Customer model with proper relationships
- `src/server/api/root.ts` - Added customer router to main appRouter
- `docs/stories/3.1.story.md` - Updated task completion status and dev record

### Final Status
✅ **READY FOR REVIEW** - All requirements implemented, tests passing, build successful

## QA Results

*To be filled by QA Agent*