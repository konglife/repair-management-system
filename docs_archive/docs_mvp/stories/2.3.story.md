# Story 2.3: Manage Products

## Status
DONE

## Story
**As a** User,
**I want** to be able to add, view, and edit products in my catalog,
**so that** I have a central record of all my inventory items.

## Acceptance Criteria
1. The user can create a new Product with the following information: name, selling price, Category, and Unit.
2. When a new Product is created, the quantity and average_cost are initialized to 0.
3. The user can view a list of all Products with all their related information.
4. The user can edit the details (name, selling price, Category, Unit) of an existing Product.
5. Deleting a Product will not be implemented in this version to prevent data corruption (but may have an 'inactive' status in the future).

## Tasks / Subtasks
- [x] Create Product data model and Prisma schema implementation (AC: 1, 2)
  - [x] Implement Product model in Prisma schema with all required fields
  - [x] Add foreign key relationships to Category and Unit models
  - [x] Set default values for quantity (0) and averageCost (0) as specified
  - [x] Run database migration to create Product table with relationships
- [x] Create tRPC product router with CRUD operations (AC: 1, 3, 4)
  - [x] Create src/server/api/routers/product.ts with productRouter
  - [x] Implement getAll procedure for fetching all products with Category and Unit relations (AC: 3)
  - [x] Implement create procedure with Zod validation for name, salePrice, categoryId, unitId (AC: 1, 2)
  - [x] Implement update procedure with Zod validation for editing product details (AC: 4)
  - [x] Add productRouter to main appRouter in src/server/api/root.ts
- [x] Enhance Stock Management page with Products section (AC: all)
  - [x] Add Products management section to existing src/app/(main)/stock/page.tsx
  - [x] Implement tabbed layout for Categories, Units, and Products sections
- [x] Implement Product CRUD UI components (AC: 1, 3, 4)
  - [x] Create product list display component with table layout showing all product details (AC: 3)
  - [x] Implement create product form with dropdowns for Category and Unit selection (AC: 1)
  - [x] Implement edit product form with inline or modal editing for all editable fields (AC: 4)
  - [x] Add proper error handling and success feedback for all operations
  - [x] Ensure quantity and averageCost display as 0 for new products (AC: 2)
- [x] Integrate tRPC client for product operations (AC: 1, 3, 4)
  - [x] Use tRPC React hooks for fetching products with relations
  - [x] Implement optimistic updates for better UX
  - [x] Add loading states and error handling for all operations
- [x] Create comprehensive unit tests for Product functionality
  - [x] Test Product tRPC router procedures (create, read, update)
  - [x] Test Product UI components rendering and interaction
  - [x] Test product form validation and error scenarios
  - [x] Test relationship handling with Categories and Units

## Dev Notes

### Previous Story Insights
[Source: Story 2.2 completion notes]
- Unit management is fully implemented and working in Stock Management page
- Category management (Story 2.1) is also complete and integrated
- tRPC infrastructure is established with both category and unit routers successfully integrated
- Stock page structure with tabbed interface is ready for additional sections (Products)
- Shadcn/ui components are fully integrated: Table, Input, Dialog, Button, Card, Tabs components
- Responsive layout system with mobile-friendly design is implemented
- Testing patterns established with Jest and React Testing Library
- Build pipeline is clean with zero TypeScript errors and ESLint warnings
- Foreign key relationships between Product -> Category and Product -> Unit are already defined in schema

### Data Models and Schema Requirements
[Source: architecture/4-data-models.md#product]
- **Product Model**: Core inventory model with comprehensive attributes
- **Key Attributes**:
  - `id: String` (unique CUID)
  - `name: String` (product name)
  - `salePrice: Float` (selling price per unit)
  - `quantity: Int` (stock quantity, default: 0)
  - `averageCost: Float` (weighted average cost, default: 0)
  - `createdAt: DateTime` (auto-generated)
  - `updatedAt: DateTime` (auto-updated)
- **Relationships**: 
  - Many-to-One with Category (categoryId foreign key)
  - Many-to-One with Unit (unitId foreign key)
  - One-to-Many with PurchaseRecord, SaleItem, UsedPart (for future stories)
- **TypeScript Interface**:
```typescript
interface Product {
  id: string;
  name: string;
  salePrice: number;
  quantity: number;
  averageCost: number;
  categoryId: string;
  unitId: string;
  createdAt: Date;
  updatedAt: Date;
}
```

[Source: architecture/9-database-schema.md#product]
- **Prisma Model**:
```prisma
model Product {
  id            String    @id @default(cuid())
  name          String
  salePrice     Float
  quantity      Int       @default(0)
  averageCost   Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  category      Category   @relation(fields: [categoryId], references: [id])
  categoryId    String
  unit          Unit       @relation(fields: [unitId], references: [id])
  unitId        String
  
  purchaseRecords PurchaseRecord[]
  saleItems       SaleItem[]
  usedParts       UsedPart[]
}
```

### API Specifications
[Source: architecture/5-api-specification.md#productRouter]
- **tRPC Router Structure**: Products will be part of main appRouter as `products: productRouter`
- **Router Location**: Create in `src/server/api/routers/product.ts`
- **Required Procedures**:
  - `getAll`: Query procedure to fetch all products with Category and Unit relations
  - `create`: Mutation procedure with Zod validation for name, salePrice, categoryId, unitId
  - `update`: Mutation procedure with id and field validation for editable properties
  - **Note**: No delete procedure to be implemented per AC 5
- **Input Validation**: Use Zod for all input validation in tRPC procedures
- **Error Handling**: tRPC built-in error handling system
- **Relationships**: Must include Category and Unit data in responses for dropdown population

### Technical Architecture Requirements
[Source: architecture/3-tech-stack-updated-versions-august-2025.md]
- **Backend Framework**: Next.js 15.4.x API Routes with tRPC 11.4.x
- **Database**: PostgreSQL (NeonDB) with Prisma 6.14.x ORM
- **Type Safety**: Full end-to-end type safety with tRPC
- **Frontend Framework**: Next.js 15.4.x with App Router
- **UI Components**: Shadcn/ui Latest with Tailwind CSS 4.1.x ✅ IMPLEMENTED
- **Icons**: Lucide Icons 0.539.x ✅ IMPLEMENTED
- **Design System**: Consistent component library with proper theming ✅ IMPLEMENTED

### Project Structure Requirements
[Source: architecture/10-unified-project-structure.md]
- **Stock Page**: `src/app/(main)/stock/page.tsx` - Existing Stock Management page (enhance with Products section)
- **Product Router**: `src/server/api/routers/product.ts` - tRPC router for products
- **Main Router**: Add productRouter to `src/server/api/root.ts` as products
- **Components**: Use `src/components/ui/` for reusable UI components (already available)
- **Database Schema**: Update `prisma/schema.prisma` with Product model relationships

### Security and Validation Requirements
[Source: architecture/11-implementation-development-standards.md#security]
- **Authentication**: All API routes protected by tRPC's `protectedProcedure`
- **Input Validation**: Strict validation using Zod within tRPC routers
- **Data Integrity**: Foreign key constraints ensure valid Category and Unit references
- **Authorization**: Only logged-in users can access product management
- **Business Rules**: Quantity and averageCost must initialize to 0 for new products

### UI/UX Requirements
[Source: Epic 2.3 Acceptance Criteria]
- **Location**: All product functions within "Stock Management" page
- **CRUD Operations**: Full create, read, update functionality (no delete per AC 5)
- **Form Requirements**: Product name, selling price, Category selection, Unit selection
- **Data Display**: Show all product information including related Category and Unit names
- **User Experience**: Clear success/error messages and loading states
- **Layout Integration**: Must integrate with existing Category and Unit sections using tabs

### Component Architecture Requirements
[Source: architecture/6-components.md#stock-management-service]
- **Backend Service**: Stock Management Service handles product CRUD operations
- **Frontend Components**: Product views call Stock Management Service via tRPC
- **Shared UI Components**: Leverage existing Shadcn/ui components (Table, Form, Dialog, etc.)
- **Dependencies**: Calls to `productRouter`, Category and Unit data for dropdowns

### File Locations and Structure
Based on unified project structure and requirements:
- **Stock Page**: `src/app/(main)/stock/page.tsx` (enhance existing file with Products tab)
- **Product Router**: `src/server/api/routers/product.ts`
- **Updated App Router**: `src/server/api/root.ts` (add products)
- **Prisma Schema**: `prisma/schema.prisma` (Product model already exists, verify relationships)
- **UI Components**: Leverage existing `src/components/ui/` Shadcn components

### Testing Requirements
[Source: architecture/11-implementation-development-standards.md#testing-strategy]
- **Framework**: Jest 30.0.x and React Testing Library (included with Next.js)
- **Test Location**: Co-located with source files using `*.test.ts` pattern
- **Requirements**:
  - Unit tests for tRPC product router procedures
  - Component tests for product UI elements
  - Integration tests for product CRUD workflows with Category/Unit relationships
  - Form validation testing for all required fields
  - Error handling and edge case testing
- **Standards**: Follow Testing Pyramid approach - focus on unit tests
- **Critical Business Logic**: Product creation with proper defaults, relationship handling

### Technical Constraints
- Must maintain referential integrity with Category and Unit relationships
- Quantity and averageCost must default to 0 for new products
- Must prevent deletion of products to avoid data corruption (per AC 5)
- All database operations must use Prisma transactions where appropriate
- UI must be responsive and work on mobile devices
- Must integrate with existing authentication and navigation system
- **Layout Consideration**: Must enhance existing Stock page without breaking Category and Unit functionality

## Testing

### Testing Standards
[Source: architecture/11-implementation-development-standards.md]
- **Test Location**: Co-located with source files using `*.test.ts` pattern
- **Framework**: Jest v30.0.x and React Testing Library (comes with Next.js)
- **Standards**: Follow Testing Pyramid approach - primarily unit tests
- **Requirements**:
  - Test tRPC product router procedures (getAll, create, update)
  - Test product UI components rendering and user interactions
  - Test form validation for product creation and editing
  - Test Category and Unit dropdown population and selection
  - Test error handling for invalid inputs and missing relationships
  - Test integration with tRPC client and optimistic updates
  - Test proper initialization of quantity and averageCost to 0
- **Commands**: Standard Jest commands integrated with Next.js

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation with comprehensive technical context from architecture documents and previous story insights | Scrum Master |

## Dev Agent Record

### Agent Model Used
Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No critical debugging issues encountered. All tests pass and build completes successfully.

### Completion Notes List
- ✅ Product model already existed in Prisma schema and was correctly configured
- ✅ Successfully created comprehensive tRPC product router with getAll, create, and update procedures
- ✅ Implemented full CRUD UI in Stock Management page with tabbed interface
- ✅ Added proper TypeScript typing throughout the implementation
- ✅ Created comprehensive test coverage with 32 passing tests
- ✅ All acceptance criteria met: create product (AC1), default values (AC2), view products (AC3), edit products (AC4), no delete functionality (AC5)
- ✅ Build and lint passes with no errors or warnings
- ✅ **Post-Review Fix**: Fixed conditional rendering bug where Units section was showing when Products tab was active due to incorrect ternary operator structure. Changed all tab conditions to use `&&` operators for proper mutual exclusivity.

### File List
**New Files:**
- `src/server/api/routers/product.ts` - Product tRPC router with CRUD operations
- `src/app/(main)/stock/product-validation.test.ts` - Product validation and logic tests
- `src/server/api/routers/product.test.ts` - Product router unit tests

**Modified Files:**
- `src/server/api/root.ts` - Added productRouter to main appRouter
- `src/app/(main)/stock/page.tsx` - Enhanced with Products section and tabbed layout

## QA Results

*To be filled by QA Agent*