# Story 4.4: View Repair Job Details

## Status
DONE

## Story
**As a** User,
**I want** to view the details of a past repair job, including all the parts used and cost breakdown,
**so that** I can review my work and profitability.

## Acceptance Criteria
1. From the repair job history list page, the user can click to view the details of each repair job.
2. The details page must display the customer's name, job title, date, and `total_cost`.
3. The details page must display a list of all `Used_Part`s in that job, along with their costs.
4. The details page must display the `parts_cost` (total cost of all parts), calculated by summing the costs of the parts.
5. The details page must display the `labor_cost` (labor/profit), calculated from `total_cost` - `parts_cost`.

## Tasks / Subtasks
- [x] Create repair detail tRPC procedure (AC: 1-5)
  - [x] Add `getById` procedure to existing repair router
  - [x] Implement Prisma query with customer and usedParts relationships
  - [x] Include product information for each used part display
  - [x] Return calculated parts cost and labor cost in response
  - [x] Add proper error handling for invalid repair IDs
- [x] Create repair job details page (AC: 1-5)
  - [x] Create new page at `src/app/(main)/repairs/[id]/page.tsx` following existing patterns
  - [x] Implement customer name, job title, date, and total cost display (AC: 2)
  - [x] Create used parts table component showing parts with costs (AC: 3)
  - [x] Display calculated parts cost and labor cost breakdown (AC: 4, 5)
  - [x] Add loading states and error handling for data fetching
  - [x] Ensure responsive design following established patterns
- [x] Update repairs list page with detail navigation (AC: 1)
  - [x] Add clickable rows or "View Details" buttons in repairs table
  - [x] Implement navigation to repair detail page with proper routing
  - [x] Ensure consistent styling with existing table patterns
- [x] Integrate tRPC client for repair detail fetching (AC: 1-5)
  - [x] Use tRPC React hooks for repair detail data fetching
  - [x] Implement proper loading states during data fetch
  - [x] Add error handling and user-friendly error messages
  - [x] Ensure proper error handling for non-existent repair IDs
- [x] Create comprehensive unit tests for repair detail functionality
  - [x] Test repair detail tRPC procedure with valid and invalid IDs
  - [x] Test cost calculations in response data (parts cost, labor cost)
  - [x] Test relationship queries (customer, products, used parts)
  - [x] Test repair detail page rendering with mock data
  - [x] Test loading states and error handling scenarios
  - [x] Test navigation from repairs list to detail page
  - [x] Test responsive design and component layout

## Dev Notes

### Previous Story Insights
[Source: Story 4.3 completion notes]
- Repair infrastructure is fully established and working, providing proven patterns for repair data management
- Repair router with create and getAll procedures is implemented and tested
- Repairs page with history table is functional and follows established UI patterns
- Database models (Repair, UsedPart) are implemented with proper relationships to Customer and Product
- tRPC router patterns are established with working authentication and validation
- UI patterns are consistent with Shadcn/ui components and responsive design
- Testing patterns are established with Jest and React Testing Library for both API and UI components
- Cost calculation logic (parts cost, labor cost) is already implemented in repair creation

### Data Models and Schema Requirements
[Source: architecture/4-data-models.md#repair + architecture/4-data-models.md#usedpart + Story 4.3 implementation]

**Repair Model**: Main repair job record for detail display
- `id: String` (unique CUID for URL parameter and data fetching)
- `customerId: String` (foreign key to Customer for name display - AC: 2)
- `description: String` (job title/description display - AC: 2)
- `totalCost: Float` (total repair price display - AC: 2)
- `partsCost: Float` (calculated total cost of all parts - AC: 4)
- `laborCost: Float` (calculated labor cost from `totalCost - partsCost` - AC: 5)
- `createdAt: DateTime` (repair job date display - AC: 2)
- **Relationships**: One Repair belongs to one Customer, One Repair has many UsedParts

**UsedPart Model**: Individual parts used in repair jobs for detail listing
- `id: String` (unique CUID)
- `repairId: String` (foreign key to Repair)
- `productId: String` (foreign key to Product for part name display - AC: 3)
- `quantity: Int` (quantity used - implemented in Story 4.3)
- `costAtTime: Float` (cost recorded at time of repair - AC: 3)
- **Relationships**: One UsedPart belongs to one Repair, One UsedPart references one Product

**Customer Model**: Existing model for customer name display
- `id: String` (relationship reference)
- `name: String` (customer name display - AC: 2)

**Product Model**: Existing model for part name display in used parts list
- `id: String` (relationship reference)
- `name: String` (product name display for parts list - AC: 3)

[Source: architecture/9-database-schema.md#prisma-relationships]
- **Prisma Query Operations**: Use include to fetch related customer and usedParts with product details
- **Query Pattern**: `repair.findUnique({ where: { id }, include: { customer: true, usedParts: { include: { product: true } } } })`
- **Cost Display**: Parts cost and labor cost are already calculated in Repair model

### API Specifications
[Source: architecture/5-api-specification.md#repairrouter + existing repair router from Story 4.3]
- **Existing Router**: Extend `src/server/api/routers/repair.ts` with new procedure
- **New Procedure Required**:
  - `getById`: Query procedure for fetching single repair with relationships (AC: 1-5)
- **Input Validation**: Use Zod schema for repair ID:
  ```typescript
  z.object({
    id: z.string().cuid("Invalid repair ID")
  })
  ```
- **Response Data**: Return repair with customer name, usedParts with product names, and calculated costs
- **Query Logic**: Use Prisma findUnique with include for relationships:
  ```typescript
  const repair = await ctx.db.repair.findUnique({
    where: { id: input.id },
    include: {
      customer: true,
      usedParts: {
        include: {
          product: true
        }
      }
    }
  });
  ```
- **Error Handling**: Handle non-existent repair IDs with proper error messages
- **Authentication**: Use existing `protectedProcedure` pattern for security

### Technical Architecture Requirements
[Source: architecture/3-tech-stack-updated-versions-august-2025.md + existing implementation]
- **Backend Framework**: Next.js 15.4.x API Routes with tRPC 11.4.x ✅ ESTABLISHED
- **Database**: PostgreSQL (NeonDB) with Prisma 6.14.x ORM ✅ ESTABLISHED
- **Type Safety**: Full end-to-end type safety with tRPC ✅ ESTABLISHED
- **Frontend Framework**: Next.js 15.4.x with App Router ✅ ESTABLISHED
- **UI Components**: Shadcn/ui Latest with Tailwind CSS 4.1.x ✅ ESTABLISHED
- **Icons**: Lucide Icons 0.539.x ✅ ESTABLISHED
- **Routing**: Use Next.js dynamic routes with [id] parameter for repair details

### Project Structure Requirements
[Source: architecture/10-unified-project-structure.md + existing codebase verification]
- **Repair Router**: Extend existing `src/server/api/routers/repair.ts` (existing file)
- **Repair Detail Page**: Create `src/app/(main)/repairs/[id]/page.tsx` (new dynamic route page)
- **Repairs List Update**: Modify existing `src/app/(main)/repairs/page.tsx` for navigation
- **UI Components**: Use existing `src/components/ui/` Shadcn components ✅ AVAILABLE
- **Testing Files**: 
  - Extend `src/server/api/routers/repair.test.ts` (existing test file)
  - Create `src/app/(main)/repairs/[id]/page.test.tsx` (new test file for detail page)

### Security and Validation Requirements
[Source: architecture/11-implementation-development-standards.md#security + existing patterns]
- **Authentication**: Use existing `protectedProcedure` pattern from tRPC ✅ ESTABLISHED
- **Input Validation**: Strict validation using Zod within tRPC router ✅ PATTERN ESTABLISHED
- **Data Access**: Only allow logged-in users to view repair details ✅ PATTERN ESTABLISHED
- **Authorization**: Only logged-in users can access repair functionality ✅ PATTERN ESTABLISHED
- **Route Protection**: Protect dynamic route with authentication middleware
- **ID Validation**: Validate repair ID format to prevent injection attacks

### UI/UX Requirements
[Source: Epic 4.4 Acceptance Criteria + existing page patterns]
- **Repair Detail Page**: New page showing comprehensive repair information (AC: 2-5)
- **Customer Information**: Display customer name prominently (AC: 2)
- **Job Information**: Show job title/description, date, and total cost (AC: 2)
- **Parts List**: Table or list showing all used parts with product names and costs (AC: 3)
- **Cost Breakdown**: Clear display of parts cost and calculated labor cost (AC: 4, 5)
- **Navigation**: Clear link/button from repairs list to detail page (AC: 1)
- **Consistent Design**: Follow established Card, Table, Typography patterns from existing functionality ✅ ESTABLISHED
- **Error Handling**: User-friendly messages for missing repairs, loading errors, etc.
- **Loading States**: Clear loading indicators during data fetching
- **Responsive Design**: Mobile and desktop compatibility following existing patterns
- **Back Navigation**: Clear way to return to repairs list page

### Component Architecture Requirements
[Source: architecture/6-components.md#transaction-service + existing implementation]
- **Backend Service**: Extend existing Repair Service within Transaction Service group (existing service)
- **Frontend Components**: New repair detail page leveraging existing infrastructure
- **Shared UI Components**: Leverage existing Shadcn/ui components (Table, Card, Typography) ✅ ESTABLISHED
- **Detail Page Pattern**: Follow established patterns from existing detail/view pages in the system
- **Navigation Pattern**: Follow established routing patterns for detail views

### File Locations and Structure
Based on existing architecture patterns and Next.js App Router:
- **Repair Router**: `src/server/api/routers/repair.ts` (extend existing file)
- **Repair Detail Page**: `src/app/(main)/repairs/[id]/page.tsx` (new dynamic route page)
- **Repairs List Update**: `src/app/(main)/repairs/page.tsx` (modify existing page)
- **UI Components**: Leverage existing `src/components/ui/` Shadcn components ✅ AVAILABLE
- **Test Files**: 
  - `src/server/api/routers/repair.test.ts` (extend existing test file)
  - `src/app/(main)/repairs/[id]/page.test.tsx` (new test file)

### Layout System Integration
[Source: existing layout implementation + architecture/12-layout-system.md]
- **MainLayout Integration**: Repair detail page integrates with existing main layout ✅ ESTABLISHED
- **Navigation**: Repair details accessible from existing repairs page navigation
- **Responsive Design**: Follow established mobile/desktop responsive patterns ✅ ESTABLISHED
- **Authentication**: Integrate with existing Clerk authentication system ✅ ESTABLISHED

### Technical Constraints
- Repair detail queries must use Prisma include to efficiently fetch related customer and parts data
- Cost calculations should display the already-calculated partsCost and laborCost from database
- Navigation must use Next.js router for proper client-side routing
- Error handling must gracefully handle non-existent repair IDs with user-friendly messaging
- Loading states must provide clear feedback during data fetching operations
- Date formatting must be consistent with existing repairs list page
- Currency formatting must be consistent with existing cost displays in the system

## Testing

### Testing Standards
[Source: architecture/11-implementation-development-standards.md#testing-strategy + existing patterns]
- **Test Location**: Create co-located test files using `*.test.ts` pattern ✅ ESTABLISHED
- **Framework**: Jest v30.0.x and React Testing Library ✅ ESTABLISHED
- **Standards**: Follow Testing Pyramid approach - primarily unit tests ✅ ESTABLISHED
- **Requirements**:
  - Extend existing repair router tests:
    - Successful repair detail fetch with relationships (customer, usedParts, products)
    - Cost calculations verification (parts cost, labor cost display)
    - Error handling for invalid repair IDs
    - Authentication requirement for detail access
    - Response data structure validation
  - Create new repair detail page component tests:
    - Page rendering with repair detail data (customer, job info, parts list)
    - Customer name, job title, date, and total cost display (AC: 2)
    - Used parts table rendering with product names and costs (AC: 3)
    - Parts cost and labor cost breakdown display (AC: 4, 5)
    - Loading states during data fetching
    - Error handling for missing repairs or failed requests
    - Responsive design and component layout
    - Navigation functionality (back to repairs list)
  - Update existing repairs list page tests:
    - Navigation to repair detail page functionality (AC: 1)
    - Clickable rows or detail buttons functionality
    - Proper routing with repair ID parameters
  - Test repair detail integration:
    - End-to-end navigation from repairs list to detail page
    - Data consistency between list and detail views
    - URL parameter handling for repair IDs
    - Authentication integration for protected routes
  - Test business logic display:
    - Cost calculation display accuracy
    - Parts listing with correct product information
    - Date and currency formatting consistency
    - Error boundary behavior for edge cases
- **Commands**: Use existing Jest commands integrated with Next.js ✅ ESTABLISHED

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-19 | 1.0 | Initial story creation with comprehensive technical context from architecture documents and previous story insights | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

No significant debug issues encountered. Implementation proceeded smoothly following established patterns.

### Completion Notes

- Successfully implemented repair detail tRPC procedure with full relationship queries
- Created comprehensive repair detail page with responsive design following established UI patterns
- Updated existing repairs list page to include navigation to detail views
- Integrated tRPC client with proper loading states and error handling
- Added extensive unit tests for both backend logic and frontend components
- All linting checks passed with no warnings or errors
- Core functionality tests passing (repair router and repairs page tests)

### File List

**Modified Files:**
- `src/server/api/routers/repair.ts` - Added getById procedure
- `src/app/(main)/repairs/page.tsx` - Added detail navigation
- `src/server/api/routers/repair.test.ts` - Extended tests for getById functionality

**New Files:**
- `src/app/(main)/repairs/[id]/page.tsx` - Repair detail page component
- `src/app/(main)/repairs/[id]/page.test.tsx` - Component tests

## QA Results

*To be filled by QA Agent*