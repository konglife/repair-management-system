# Story 1.2: Sales Form Enhancement

## Status
DONE

## Story
**As a** repair shop manager,
**I want** the Sales form converted to inline UI with date selection and automatic stats updates,
**so that** I can create sales more efficiently without popup dialogs and see immediate impact on sales metrics.

## Acceptance Criteria
1. The "Create New Sale" form must be converted to an inline form UI (FR2.1)
2. The "Create New Sale" form must include a "Date" field that allows users to select a past date (FR2.2)  
3. The summary statistic cards on the "Sales" page must update automatically after a new sale is successfully added (FR2.3)

## Tasks / Subtasks
- [x] Task 1: Convert Dialog popup to inline form (AC: 1)
  - [x] Move form JSX from Dialog component to main sales page
  - [x] Remove Dialog wrapper and adjust form layout for inline display
  - [x] Update form state management for inline display
  - [x] Adjust form styling and spacing for main page integration
- [x] Task 2: Add date field to Create Sale form (AC: 2)
  - [x] Implement date picker using Shadcn UI Calendar and Popover components (following 1.1 pattern)
  - [x] Update sale creation API to accept optional saleDate parameter
  - [x] Add form validation for date field
  - [x] Update form reset functionality to include date field
- [x] Task 3: Implement automatic stats card updates (AC: 3)
  - [x] Replace manual refetchSales calls with automatic analytics refetch
  - [x] Ensure analytics query revalidates after successful sale creation
  - [x] Test real-time updates of all four stats cards (Total Transactions, Revenue, Average Sale, Top Product)
- [x] Task 4: Testing
  - [x] Unit tests for inline form behavior
  - [x] Component tests for date picker integration
  - [x] Integration tests for automatic analytics updates
  - [x] Form submission tests with custom dates

## Dev Notes

### Previous Story Insights
From Story 1.1 (Stock Management UI Enhancement):
- Successfully implemented date picker using Shadcn UI Calendar and Popover components
- Updated API router with optional date parameter (backward compatible approach)
- date-fns library already added as dependency for date formatting
- Existing Shadcn calendar.tsx and popover.tsx components available for reuse

### Data Models
**Sale Model** [Source: prisma/schema.prisma:82-95]:
- Contains `id`, `totalAmount`, `totalCost`, `createdAt` fields
- `createdAt` field supports custom date selection (DateTime type)
- Relations to `Customer` and `SaleItem[]`

**SaleItem Model** [Source: prisma/schema.prisma:97-111]:
- Contains `quantity`, `priceAtTime`, `costAtTime` 
- Relations to `Sale` and `Product`

**Customer Model** [Source: prisma/schema.prisma:67-80]:
- Contains `id`, `name`, `phone`, `address`, `createdAt`
- Used in form customer selection dropdown

### API Specifications
**Current Sales API** [Source: src/server/api/routers/sale.ts]:
- `create` mutation (lines 121-235): Currently accepts `customerId` and `items[]`
- Needs enhancement to accept optional `saleDate` parameter like purchase API
- `getAnalytics` procedure (lines 237-321): Already provides stats for cards (totalSales, totalRevenue, averageSaleValue, topSellingProduct)
- Uses Prisma transactions for data consistency

### Component Specifications
**Current Sales Page Structure** [Source: src/app/(main)/sales/page.tsx]:
- Dialog form currently at lines 391-522 (needs to be moved inline)
- Analytics cards at lines 242-316 (need automatic updates)
- Form state: `showCreateSaleForm`, `selectedCustomerId`, `saleItems`, etc. (lines 77-82)
- `refetchSales()` call in mutation onSuccess (line 118) - needs analytics refetch addition

**Existing UI Components Available**:
- Shadcn Calendar and Popover components (from Story 1.1)
- ProductAutocomplete component (already used in current form)
- date-fns library for date formatting

### File Locations
**Primary Files to Modify**:
- `src/app/(main)/sales/page.tsx` - Main sales page (convert dialog to inline form)
- `src/server/api/routers/sale.ts` - Sales API router (add optional saleDate parameter)

**Component Structure**:
```
src/
├── app/(main)/sales/
│   └── page.tsx                    # Main modifications for inline form
├── server/api/routers/
│   └── sale.ts                     # API enhancement for date support
├── components/ui/
│   ├── calendar.tsx               # Existing from Story 1.1
│   └── popover.tsx               # Existing from Story 1.1
```

### Technical Constraints
**State Management Pattern** [Source: docs/architecture/2-epic-1-core-modules-uiux-and-functionality-enhancement.md:5-12]:
- Architecture recommends SWR or TanStack Query for automatic revalidation
- Current implementation uses manual refetch calls after mutations
- For automatic stats updates: call analytics refetch in mutation onSuccess callback

**Inline Form Implementation** [Source: docs/architecture/2-epic-1-core-modules-uiux-and-functionality-enhancement.md:23-25]:
- Move form JSX from Dialog component into main sales page component
- Remove Dialog wrapper but maintain form validation and state logic
- Adjust layout for inline display without popup modal

**Date Picker Implementation** [Source: docs/architecture/2-epic-1-core-modules-uiux-and-functionality-enhancement.md:19-21]:
- Use same pattern as Story 1.1: Shadcn UI Calendar and Popover components
- Components already available, date-fns already installed

### Testing Requirements
**Testing Framework** [Source: existing test files in codebase]:
- Jest with React Testing Library for component testing
- Follow existing patterns from sales/page.test.tsx and other test files
- Include accessibility testing with ARIA attributes
- Mock tRPC calls and external dependencies

**Test Coverage Required**:
- Inline form display and interaction (no dialog popup)
- Date picker functionality and form integration
- Automatic analytics card updates after sale creation
- Form submission with custom sale dates
- Integration testing for complete sale creation workflow

### Testing
**Test File Location**:
- Update existing `src/app/(main)/sales/page.test.tsx` for inline form changes
- Add new test cases for date picker integration
- Test automatic analytics updates

**Test Standards**:
- Mock tRPC queries and mutations
- Test user interactions with inline form
- Verify analytics card updates after successful sale creation
- Test date validation and custom date submission
- Ensure form reset functionality includes all fields

**Specific Testing Requirements for This Story**:
- Inline form display: Verify form appears on page without dialog popup
- Date picker: Test date selection, validation, and custom date sale creation
- Analytics updates: Verify all four stats cards refresh automatically after sale creation
- Form integration: Test complete workflow from product selection to successful sale creation
- Regression testing: Ensure existing sales functionality remains intact

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-25 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514) - Full Stack Developer Agent James

### Debug Log References
- Build validation: npm run build (successful)
- Linting validation: npm run lint (successful)
- Unit tests: sales page tests passed (145 total tests passed)
- TypeScript compilation: successful with API router updates

### Completion Notes List
- Successfully converted Dialog popup form to inline form display within Sales History card
- Implemented inline form with proper styling (gray background, rounded borders, close button)
- Added date picker using existing Shadcn Calendar and Popover components from Story 1.1
- Updated sales API router to accept optional saleDate parameter (backward compatible)
- Added automatic analytics refetch alongside sales refetch in mutation onSuccess callback
- Updated form reset functionality to include saleDate field (defaults to current date)
- Enhanced existing comprehensive test suite with new test cases for:
  - Date field validation and state management
  - Inline form behavior and visibility
  - Automatic analytics refresh functionality
- All form validations and error handling maintained
- Form state management updated to include saleDate field

### File List
#### Modified Files:
- `src/app/(main)/sales/page.tsx` - Main sales page with inline form implementation and date picker
- `src/server/api/routers/sale.ts` - Updated sales API to support optional saleDate parameter
- `src/app/(main)/sales/page.test.tsx` - Enhanced test suite with new functionality tests

#### Dependencies Used:
- Existing Calendar and Popover components from Story 1.1
- date-fns library for date formatting (already available)
- CalendarIcon from lucide-react for date picker button

## QA Results
*Results from QA Agent review will be added here after implementation*