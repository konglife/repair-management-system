# Story 2.4: Record Stock Purchases

## Status
DONE

## Story
**As a** User,
**I want** to record a new stock purchase for a product,
**so that** the stock quantity and average cost are updated correctly.

## Acceptance Criteria
1. The user can initiate a "Record Purchase" from the "Stock Management" page.
2. The user selects an existing Product, enters the quantity purchased, and the cost per unit for that purchase.
3. Upon saving, the system creates a new `Purchase_Record`.
4. The `quantity` of the selected Product is increased by the amount purchased.
5. The `average_cost` of the selected Product is recalculated based on the weighted average principle.
6. The user can view the purchase history for each Product.

## Tasks / Subtasks
- [x] Create PurchaseRecord data model and Prisma schema implementation (AC: 3)
  - [x] Verify PurchaseRecord model exists in Prisma schema with all required fields
  - [x] Ensure foreign key relationship to Product model is correctly defined
  - [x] Run database migration if schema changes are needed
- [x] Create tRPC purchase router with purchase recording operations (AC: 1, 2, 3, 4, 5)
  - [x] Create src/server/api/routers/purchase.ts with purchaseRouter
  - [x] Implement create procedure with Zod validation for productId, quantity, costPerUnit
  - [x] Implement getByProduct procedure for fetching purchase history by productId (AC: 6)
  - [x] Include weighted average cost calculation logic in create procedure (AC: 5)
  - [x] Include product quantity update logic in create procedure (AC: 4)
  - [x] Add purchaseRouter to main appRouter in src/server/api/root.ts
- [x] Enhance Stock Management page with Purchase Recording section (AC: 1)
  - [x] Add Purchase Recording section to existing src/app/(main)/stock/page.tsx
  - [x] Extend existing tabbed layout to include "Record Purchase" tab
  - [x] Ensure seamless integration with existing Categories, Units, and Products tabs
- [x] Implement Purchase Recording UI components (AC: 1, 2, 6)
  - [x] Create purchase form with Product dropdown, quantity input, and cost per unit input (AC: 2)
  - [x] Implement product selection dropdown populated from existing products
  - [x] Add purchase history view component showing all purchases for selected product (AC: 6)
  - [x] Include proper validation for quantity (positive integers) and cost (positive numbers)
  - [x] Add success/error feedback for purchase recording operations
- [x] Integrate tRPC client for purchase operations (AC: 1, 2, 3, 4, 5, 6)
  - [x] Use tRPC React hooks for purchase creation and history retrieval
  - [x] Implement optimistic updates for better UX on successful purchases
  - [x] Add loading states and error handling for all purchase operations
  - [x] Ensure real-time updates to product quantity and average cost after purchase
- [x] Create comprehensive unit tests for Purchase functionality
  - [x] Test PurchaseRecord tRPC router procedures (create, getByProduct)
  - [x] Test weighted average cost calculation logic with multiple scenarios
  - [x] Test product quantity update logic
  - [x] Test purchase UI components rendering and interaction
  - [x] Test purchase form validation and error scenarios
  - [x] Test integration between purchase recording and product updates

## Dev Notes

### Previous Story Insights
[Source: Story 2.3 completion notes]
- Product management is fully implemented and working in Stock Management page
- Category and Unit management (Stories 2.1, 2.2) are complete and integrated
- tRPC infrastructure is established with category, unit, and product routers successfully integrated
- Stock page structure with tabbed interface is ready for additional sections (Purchase Recording)
- Shadcn/ui components are fully integrated: Table, Input, Dialog, Button, Card, Tabs components
- Responsive layout system with mobile-friendly design is implemented
- Testing patterns established with Jest and React Testing Library
- Build pipeline is clean with zero TypeScript errors and ESLint warnings
- Product model with quantity and averageCost fields is already implemented and ready for updates

### Data Models and Schema Requirements
[Source: architecture/4-data-models.md#purchase-record]
- **PurchaseRecord Model**: Records history of stock purchases for average cost calculation
- **Key Attributes**:
  - `id: String` (unique CUID)
  - `productId: String` (foreign key to Product)
  - `quantity: Int` (quantity purchased in transaction)
  - `costPerUnit: Float` (cost per unit for this purchase)
  - `purchaseDate: DateTime` (auto-generated timestamp)
- **Relationships**: 
  - Many-to-One with Product (productId foreign key)
- **TypeScript Interface**:
```typescript
interface PurchaseRecord {
  id: string;
  productId: string;
  quantity: number;
  costPerUnit: number;
  purchaseDate: Date;
}
```

[Source: architecture/9-database-schema.md#purchaserecord]
- **Prisma Model**:
```prisma
model PurchaseRecord {
  id           String   @id @default(cuid())
  quantity     Int
  costPerUnit  Float
  purchaseDate DateTime @default(now())
  
  // Relation
  product      Product @relation(fields: [productId], references: [id])
  productId    String
}
```

### Weighted Average Cost Calculation Logic
[Source: architecture/4-data-models.md#product + Epic 2.4 AC5]
- **Current Logic**: When recording a purchase, Product.averageCost must be recalculated using weighted average
- **Formula**: `newAverageCost = ((currentQuantity * currentAverageCost) + (purchaseQuantity * purchaseCostPerUnit)) / (currentQuantity + purchaseQuantity)`
- **Edge Case**: If currentQuantity is 0, newAverageCost = purchaseCostPerUnit
- **Update Sequence**: 
  1. Calculate new weighted average cost
  2. Update Product.averageCost with new value
  3. Update Product.quantity by adding purchase quantity
  4. Create PurchaseRecord entry

### API Specifications
[Source: architecture/5-api-specification.md#purchaseRouter]
- **tRPC Router Structure**: Purchases will be part of main appRouter as `purchases: purchaseRouter`
- **Router Location**: Create in `src/server/api/routers/purchase.ts`
- **Required Procedures**:
  - `create`: Mutation procedure with Zod validation for productId, quantity, costPerUnit
  - `getByProduct`: Query procedure to fetch purchase history for a specific productId
- **Input Validation**: Use Zod for all input validation in tRPC procedures
- **Business Logic**: Create procedure must handle both PurchaseRecord creation and Product updates atomically
- **Error Handling**: tRPC built-in error handling system
- **Transaction Safety**: Use Prisma transactions to ensure data consistency

### Technical Architecture Requirements
[Source: architecture/3-tech-stack-updated-versions-august-2025.md]
- **Backend Framework**: Next.js 15.4.x API Routes with tRPC 11.4.x
- **Database**: PostgreSQL (NeonDB) with Prisma 6.14.x ORM
- **Type Safety**: Full end-to-end type safety with tRPC
- **Frontend Framework**: Next.js 15.4.x with App Router
- **UI Components**: Shadcn/ui Latest with Tailwind CSS 4.1.x ✅ IMPLEMENTED
- **Icons**: Lucide Icons 0.539.x ✅ IMPLEMENTED
- **Design System**: Consistent component library with proper theming ✅ IMPLEMENTED

### Project Structure Requirements
[Source: architecture/10-unified-project-structure.md]
- **Stock Page**: `src/app/(main)/stock/page.tsx` - Existing Stock Management page (enhance with Purchase Recording section)
- **Purchase Router**: `src/server/api/routers/purchase.ts` - tRPC router for purchases
- **Main Router**: Add purchaseRouter to `src/server/api/root.ts` as purchases
- **Components**: Use `src/components/ui/` for reusable UI components (already available)
- **Database Schema**: PurchaseRecord model already exists in `prisma/schema.prisma`

### Security and Validation Requirements
[Source: architecture/11-implementation-development-standards.md#security]
- **Authentication**: All API routes protected by tRPC's `protectedProcedure`
- **Input Validation**: Strict validation using Zod within tRPC routers
- **Data Integrity**: Foreign key constraints ensure valid Product references
- **Authorization**: Only logged-in users can access purchase recording
- **Business Rules**: Quantity must be positive integer, costPerUnit must be positive number
- **Transaction Safety**: Use Prisma transactions for atomic updates to PurchaseRecord and Product

### UI/UX Requirements
[Source: Epic 2.4 Acceptance Criteria]
- **Location**: All purchase recording functions within "Stock Management" page
- **Integration**: Must integrate with existing Categories, Units, and Products tabs
- **Form Requirements**: Product selection dropdown, quantity input, cost per unit input
- **Data Display**: Show purchase history for each product with date, quantity, cost details
- **User Experience**: Clear success/error messages and loading states
- **Layout Integration**: Extend existing tabbed interface without breaking current functionality

### Component Architecture Requirements
[Source: architecture/6-components.md#stock-management-service]
- **Backend Service**: Stock Management Service handles purchase recording operations
- **Frontend Components**: Purchase views call Stock Management Service via tRPC
- **Shared UI Components**: Leverage existing Shadcn/ui components (Table, Form, Dialog, etc.)
- **Dependencies**: Calls to `purchaseRouter`, Product data for dropdown population

### File Locations and Structure
Based on unified project structure and requirements:
- **Stock Page**: `src/app/(main)/stock/page.tsx` (enhance existing file with Purchase Recording tab)
- **Purchase Router**: `src/server/api/routers/purchase.ts`
- **Updated App Router**: `src/server/api/root.ts` (add purchases)
- **Prisma Schema**: `prisma/schema.prisma` (PurchaseRecord model already exists)
- **UI Components**: Leverage existing `src/components/ui/` Shadcn components

### Testing Requirements
[Source: architecture/11-implementation-development-standards.md#testing-strategy]
- **Framework**: Jest 30.0.x and React Testing Library (included with Next.js)
- **Test Location**: Co-located with source files using `*.test.ts` pattern
- **Requirements**:
  - Unit tests for tRPC purchase router procedures
  - Unit tests for weighted average cost calculation logic (critical business logic)
  - Component tests for purchase UI elements and form validation
  - Integration tests for purchase recording workflows with Product updates
  - Error handling and edge case testing (zero quantity products, invalid inputs)
- **Standards**: Follow Testing Pyramid approach - focus on unit tests
- **Critical Business Logic**: Weighted average calculation, quantity updates, transaction atomicity

### Technical Constraints
- Must maintain referential integrity with Product relationships
- Quantity must be positive integer, costPerUnit must be positive number
- Must use Prisma transactions to ensure atomic updates to both PurchaseRecord and Product
- UI must be responsive and work on mobile devices
- Must integrate with existing authentication and navigation system
- **Layout Consideration**: Must enhance existing Stock page without breaking Categories, Units, and Products functionality
- **Data Consistency**: Purchase recording and product updates must be atomic operations

## Testing

### Testing Standards
[Source: architecture/11-implementation-development-standards.md]
- **Test Location**: Co-located with source files using `*.test.ts` pattern
- **Framework**: Jest v30.0.x and React Testing Library (comes with Next.js)
- **Standards**: Follow Testing Pyramid approach - primarily unit tests
- **Requirements**:
  - Test tRPC purchase router procedures (create, getByProduct)
  - Test weighted average cost calculation with multiple scenarios:
    - First purchase (zero quantity product)
    - Subsequent purchases with different costs
    - Large quantity purchases
    - Edge cases with very small/large numbers
  - Test product quantity update logic
  - Test purchase UI components rendering and user interactions
  - Test form validation for purchase creation
  - Test Product dropdown population and selection
  - Test error handling for invalid purchases and network failures
  - Test integration with tRPC client and optimistic updates
  - Test transaction atomicity (ensure both PurchaseRecord and Product are updated together)
- **Commands**: Standard Jest commands integrated with Next.js

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation with comprehensive technical context from architecture documents and previous story insights | Scrum Master |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- N/A - No blocking issues encountered

### Completion Notes
✅ **Story Status**: COMPLETED SUCCESSFULLY

**All Acceptance Criteria Implemented:**
1. ✅ AC1: User can initiate "Record Purchase" from Stock Management page (added as new tab)
2. ✅ AC2: User selects Product, enters quantity and cost per unit (form with dropdowns and inputs)
3. ✅ AC3: System creates new PurchaseRecord (tRPC create procedure implemented)
4. ✅ AC4: Product quantity increased by purchase amount (atomic transaction update)
5. ✅ AC5: Product average_cost recalculated using weighted average (business logic implemented)
6. ✅ AC6: User can view purchase history for each Product (history table with date/quantity/cost)

**Implementation Summary:**
- ✅ Database: Added PurchaseRecord model to Prisma schema with proper relations
- ✅ Backend: Created purchase tRPC router with create and getByProduct procedures
- ✅ Frontend: Enhanced Stock Management page with Purchase Recording tab
- ✅ UI: Implemented purchase form with product selection, quantity, and cost inputs
- ✅ UX: Added purchase history table with date, quantity, cost, and total calculations
- ✅ Business Logic: Implemented weighted average cost calculation with proper edge case handling
- ✅ Validation: Added comprehensive input validation for all purchase fields
- ✅ Testing: Created unit tests for business logic covering multiple scenarios
- ✅ Integration: Purchase recording seamlessly integrated with existing Stock Management tabs

**Key Technical Features:**
- Atomic transactions ensure data consistency between PurchaseRecord and Product updates
- Weighted average cost calculation handles first purchase (zero stock) and subsequent purchases
- Form validation prevents invalid quantities (must be positive integers) and costs
- Real-time product quantity and average cost updates after successful purchase recording
- Purchase history sorted by date (most recent first) with calculated total costs
- Responsive design works on mobile and desktop devices
- Loading states and error handling for all operations

**Post-Implementation Enhancement (v2.1):**
- ✅ Enhanced Purchase History to show all purchases by default (improved UX)
- ✅ Added Product name column when viewing all purchases
- ✅ Dropdown now shows "All Purchases" as default option with product filtering
- ✅ Dynamic table headers based on view mode (all vs product-specific)
- ✅ Optimized data fetching with separate queries for all purchases and product-specific history

### File List
**Created Files:**
- `src/server/api/routers/purchase.ts` - tRPC purchase router with create, getByProduct, and getAll procedures
- `src/server/api/routers/purchase-logic.test.ts` - Business logic unit tests (26 test cases)
- `src/app/(main)/stock/page.test.tsx` - UI component tests for purchase functionality

**Modified Files:**
- `prisma/schema.prisma` - Added PurchaseRecord model with Product relation
- `src/server/api/root.ts` - Added purchase router to main appRouter
- `src/app/(main)/stock/page.tsx` - Enhanced with Purchase Recording tab and functionality

**Database Migration:**
- `prisma/migrations/20250817095736_add_purchase_record/migration.sql` - Applied successfully

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation with comprehensive technical context | Scrum Master |
| 2025-08-17 | 2.0 | COMPLETED - Full Purchase Recording functionality implemented and tested | Dev Agent |
| 2025-08-17 | 2.1 | ENHANCED - Purchase History now shows all purchases by default with product filtering | Dev Agent |

### Status
Ready for Review - Enhanced with improved Purchase History UX

## QA Results

*To be filled by QA Agent*