# Story 3.1: Create Settings Page Foundation

## Status
DONE

## Story
**As a** admin,
**I want** a new "Settings" page where I can manage my business profile information,
**so that** I can configure my business information and prepare for PDF report generation with proper business branding.

## Acceptance Criteria
1. Add a new "Settings" menu item to the sidebar (FR33)
2. Create a new Settings page with business profile form (FR34)
3. Create new database table for BusinessProfile (FR33, FR34)
4. Form includes fields for: Shop Name, Address, Phone Number, Contact Email, Company Logo URL (FR34.1-34.5)
5. Implement create/update functionality for business profile data
6. Follow existing UI patterns and styling conventions
7. Include proper form validation and error handling
8. Ensure responsive design for mobile and desktop viewing

## Tasks / Subtasks
- [x] Task 1: Create BusinessProfile database model and migration (AC: 3)
  - [x] Add BusinessProfile model to Prisma schema with all required fields
  - [x] Generate and apply database migration using `prisma migrate dev`
  - [x] Update Prisma client generation
- [x] Task 2: Create Settings tRPC API procedures (AC: 5)
  - [x] Create settings router with getBusinessProfile procedure
  - [x] Create createOrUpdateBusinessProfile mutation procedure
  - [x] Add proper input validation using Zod schemas
  - [x] Integrate settings router into main tRPC router
- [x] Task 3: Create Settings page structure (AC: 1, 2)
  - [x] Create `/src/app/(main)/settings/page.tsx` following existing page patterns
  - [x] Add Settings menu item to sidebar navigation
  - [x] Implement proper layout and responsive design
- [x] Task 4: Implement BusinessProfile form component (AC: 4, 6, 7)
  - [x] Create form component with all business profile fields
  - [x] Implement form validation using existing patterns
  - [x] Add proper loading states and error handling
  - [x] Follow existing styling conventions and UI patterns
- [x] Task 5: Integration and testing (AC: 8, All)
  - [x] Test form submission and data persistence
  - [x] Verify responsive design across different screen sizes
  - [x] Test navigation integration with sidebar
  - [x] Verify proper error handling and validation messages

## Dev Notes

### Previous Story Insights
From Stories 2.1-2.5:
- tRPC router pattern established and working well for API procedures
- Page structure patterns consistent using `(main)` layout group
- Form patterns established for data entry with validation
- Sidebar navigation integration patterns established
- Thai Baht (à¸¿) currency formatting patterns established (may be relevant for future settings)
- Responsive design patterns consistently implemented across dashboard modules

### Data Models
[Source: architecture/3-data-models-and-schema-changes.md]
**New Model Required: BusinessProfile**
```prisma
model BusinessProfile {
  id                String  @id @default(cuid())
  shopName          String
  address           String?
  phoneNumber       String?
  contactEmail      String?
  logoUrl           String?
  lowStockThreshold Int     @default(5)

  @@map("business_profiles")
}
```
- Migration strategy: Use `prisma migrate dev --name add_business_profile`
- System must handle case where no business profile exists yet (provide defaults or setup prompt)

### API Specifications
[Source: architecture/4-component-api-architecture.md]
**New API Endpoints Required:**
- `POST /api/settings` - Create or update business profile (Admin only)
- `GET /api/settings` - Retrieve current business profile

**tRPC Implementation:**
- Create new settings router with procedures for get/create/update operations
- Input validation using Zod schemas
- Proper error handling and type safety

### Component Specifications
[Source: architecture/4-component-api-architecture.md and architecture/5-source-tree-integration.md]

**New Page Location:**
- `/src/app/(main)/settings/page.tsx` - New settings page following existing page patterns

**Form Fields Required:**
- Shop Name (required string field)
- Address (optional string field)  
- Phone Number (optional string field)
- Contact Email (optional string field with email validation)
- Company Logo URL (optional string field with URL validation)

**Technical Requirements:**
- Follow existing form patterns and styling conventions
- Use existing UI components and patterns from shadcn/ui
- Implement proper form validation with error messaging
- Include loading states during form submission
- Ensure responsive design using existing Tailwind CSS patterns
- Add proper TypeScript typing throughout

### File Locations
[Source: architecture/5-source-tree-integration.md]
**New Files to Create:**
- `/src/app/(main)/settings/page.tsx` - Settings page component
- Migration file: `prisma/migrations/..._add_business_profile/` - Database migration
- `prisma/schema.prisma` - Modified to add BusinessProfile model
- tRPC router files for settings API procedures

**Integration Points:**
- Sidebar navigation: Add Settings menu item
- Main layout: Settings page uses existing `(main)` layout group
- Database: New BusinessProfile table integration

### Technical Constraints
[Source: architecture/2-tech-stack-alignment.md]
- Use existing tech stack: Next.js, TypeScript, Tailwind CSS, tRPC, Prisma
- Follow established patterns from existing pages and components
- No new external dependencies required for basic settings functionality
- Maintain consistency with existing UI patterns and styling
- Form validation should follow existing patterns (Zod schemas, error handling)

### Project Structure Notes
The Settings page aligns perfectly with the existing project structure using the `(main)` layout group. The BusinessProfile database model follows established Prisma patterns. The page structure and component organization match existing patterns from other modules (Stock, Sales, Repairs, Customers).

### Testing
**Testing Standards** [Source: architecture/6-testing-strategy.md]:
- **Test Location**: Co-located test files following established patterns
- **Testing Framework**: Jest and React Testing Library 
- **Test Coverage**: Focus on settings page functionality and database operations
- **Unit Tests**: Settings page component, form validation, tRPC procedures
- **Integration Tests**: End-to-end test for "Admin successfully updates settings" workflow
- **Manual Testing**: Full regression test to ensure settings doesn't break existing functionality

**Specific Testing Requirements:**
- Test form validation for all business profile fields
- Test successful form submission and data persistence  
- Test error handling for network failures and validation errors
- Test responsive design across different screen sizes
- Test navigation integration with sidebar menu
- Test loading states during form operations
- Test handling of empty/new business profile vs existing profile scenarios

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-23 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
*To be populated by development agent*

### Completion Notes List
- Successfully created BusinessProfile database model with all required fields
- Generated and applied database migration: `20250823124842_add_business_profile`
- Created settings tRPC router with getBusinessProfile and createOrUpdateBusinessProfile procedures
- Implemented comprehensive form validation using Zod schemas
- Built complete Settings page with responsive design following existing patterns
- Added Settings menu item to sidebar navigation with proper icon
- All validation includes required fields, email format, URL format, and numeric constraints
- Form includes proper loading states, error handling, and success feedback
- Successfully passed ESLint checks and production build compilation
- Created basic unit tests for the Settings page functionality

### File List
**New Files Created:**
- `src/server/api/routers/settings.ts` - Settings tRPC router with business profile procedures
- `src/app/(main)/settings/page.tsx` - Settings page component with business profile form
- `src/app/(main)/settings/page.test.tsx` - Unit tests for Settings page
- `prisma/migrations/20250823124842_add_business_profile/migration.sql` - Database migration for BusinessProfile table

**Modified Files:**
- `prisma/schema.prisma` - Added BusinessProfile model
- `src/server/api/root.ts` - Added settings router to main tRPC router
- `src/components/layout/sidebar.tsx` - Added Settings menu item with icon

## QA Results
*Results from QA Agent review will be populated here after implementation*