# Story 3.4: Implement PDF Generation Logic

## Status
Ready for Review

## Story
**As an** admin,
**I want** the system to generate a well-formatted PDF report based on my selection, incorporating my business name and logo from the settings,
**so that** I can produce professional monthly reports for my business analysis and record-keeping.

## Acceptance Criteria
1. Enable the "Generate Report" button on the Reports page to trigger PDF generation (building on Story 3.3)
2. Implement monthly Sales PDF report generation that includes business information from settings (FR30.1, FR35)
3. Implement monthly Repairs PDF report generation summarizing revenue, parts cost, and gross profit (FR30.2, FR35)
4. Ensure generated PDFs are well-formatted and professional-looking (FR32)
5. Include shop name and logo from BusinessProfile settings in PDF headers (FR35)
6. Handle cases where business profile information is incomplete or missing
7. Provide user feedback during PDF generation process (loading states, success/error messages)
8. Enable PDF download or display functionality for the generated reports

## Tasks / Subtasks
- [x] Task 1: Set up PDF generation infrastructure (AC: 1, 4)
  - [x] Install and configure pdf-lib library for server-side PDF generation
  - [x] Create PDF generation utility functions and templates
  - [x] Set up proper file structure for PDF generation logic
  - [x] Implement error handling and logging for PDF operations
- [x] Task 2: Create Sales PDF report generation API endpoint (AC: 2, 5, 6)
  - [x] Create tRPC procedure for sales report generation
  - [x] Query sales data for the specified month/year
  - [x] Fetch BusinessProfile information for header content
  - [x] Generate formatted PDF with sales data using pdf-lib
  - [x] Include business name and logo in PDF header
  - [x] Handle missing business information gracefully
- [x] Task 3: Create Repairs PDF report generation API endpoint (AC: 3, 5, 6)
  - [x] Create tRPC procedure for repairs report generation
  - [x] Query repairs data for the specified month/year with cost calculations
  - [x] Calculate total revenue, parts cost, and gross profit
  - [x] Generate formatted PDF with repairs summary using pdf-lib
  - [x] Include business name and logo in PDF header
  - [x] Handle missing business information gracefully
- [x] Task 4: Integrate PDF generation with Reports page frontend (AC: 1, 7, 8)
  - [x] Enable the "Generate Report" button in Reports page
  - [x] Implement form submission handling for report generation
  - [x] Add loading states and user feedback during generation
  - [x] Handle PDF download/display after successful generation
  - [x] Implement proper error handling and user messaging
  - [x] Add validation to ensure all required fields are selected
- [x] Task 5: Testing and quality assurance (AC: all)
  - [x] Write unit tests for PDF generation utility functions
  - [x] Write integration tests for tRPC procedures
  - [x] Write component tests for Reports page PDF generation functionality
  - [x] Test with various data scenarios (empty months, missing business info)
  - [x] Verify PDF format and content quality
  - [x] Test error handling and edge cases

## Dev Notes

### Previous Story Insights
From Story 3.3:
- Reports page foundation is complete with working form controls for report type selection (Sales/Repairs) and month/year selection
- Generate Report button exists but is disabled, ready for activation in this story
- Form validation and state management patterns are established and working
- Business Profile database model exists and is populated via Settings page (Stories 3.1/3.2)
- UI patterns and responsive design are consistent across the application

### Data Models
[Source: architecture/3-data-models-and-schema-changes.md]
**BusinessProfile Model (Already Implemented):**
```prisma
model BusinessProfile {
  id                String  @id @default(cuid())
  shopName          String
  address           String?
  phoneNumber       String?
  contactEmail      String?
  logoUrl           String?
  lowStockThreshold Int     @default(5)
  @@map("business_profiles")
}
```
**Key Data Requirements:**
- Sales data will be queried from existing Sales model for specified month/year
- Repairs data will be queried from existing Repairs model with cost calculations
- BusinessProfile data will provide shop name and logo for PDF headers
- Must handle cases where BusinessProfile might not exist or have missing fields

### API Specifications
[Source: architecture/4-component-api-architecture.md]
**New tRPC Procedures Required:**
- `reports.generateSalesReport` - Generate monthly sales PDF report (requires month, year parameters)
- `reports.generateRepairsReport` - Generate monthly repairs PDF report (requires month, year parameters)

**Note:** The architecture document mentions traditional API routes (`/api/reports/sales`, `/api/reports/repairs`), but this project uses tRPC, so the implementation should follow the existing tRPC pattern instead.

**Data Flow:**
1. Frontend form submission triggers tRPC procedure call
2. Server-side procedure queries relevant data for specified month/year
3. BusinessProfile information is fetched for header content
4. PDF is generated using pdf-lib with formatted data
5. PDF buffer is returned to client for download/display

### Component Specifications
[Source: architecture/4-component-api-architecture.md and architecture/5-source-tree-integration.md]

**Existing Files to Modify:**
- `/src/app/(main)/reports/page.tsx` - Enable Generate Report button and add PDF generation logic
- Reports page form controls and validation are already implemented

**New Backend Logic Required:**
- PDF generation utility functions using pdf-lib
- tRPC procedures in reports router
- Data querying and aggregation logic for reports
- Error handling and validation logic

**PDF Generation Requirements:**
- Professional formatting with business branding
- Sales report: Include sales transactions, totals, product breakdowns
- Repairs report: Include repair jobs, revenue, parts cost, gross profit calculations
- Header with business name and logo (when available)
- Proper date formatting and month/year context

### File Locations
[Source: architecture/5-source-tree-integration.md]
**Files to Create:**
- `/src/lib/pdf-generator.ts` - PDF generation utility functions
- `/src/server/api/routers/reports.ts` - tRPC procedures for report generation
- Update `/src/server/api/root.ts` - Add reports router to main tRPC router

**Files to Modify:**
- `/src/app/(main)/reports/page.tsx` - Enable PDF generation functionality
- Update reports page tests to cover PDF generation features

**Project Structure Notes:**
The implementation should follow the existing tRPC pattern used throughout the project rather than traditional API routes mentioned in the architecture document.

### Testing Requirements
[Source: architecture/6-testing-strategy.md]
**Testing Standards:**
- **Test Locations**: 
  - `/src/lib/pdf-generator.test.ts` - Unit tests for PDF generation logic
  - `/src/app/(main)/reports/page.test.tsx` - Updated component tests
  - Integration tests for tRPC procedures (follow existing patterns)
- **Testing Framework**: Jest and React Testing Library (existing setup)

**Specific Testing Requirements:**
- Test PDF generation utility functions with various data inputs
- Test tRPC procedures for both sales and repairs report generation
- Test error handling for missing business profile information  
- Test Reports page PDF generation button functionality and user feedback
- Test file download/display functionality
- Test edge cases: empty data periods, malformed data, network errors
- Test PDF content quality and formatting
- Verify business name and logo integration in generated PDFs

### Technical Constraints
[Source: architecture/2-tech-stack-alignment.md]
- **PDF Library**: Use `pdf-lib` version ^1.17.1 for server-side PDF generation (already specified in tech stack)
- **Existing Tech Stack**: Continue using tRPC for API layer, maintain consistency with existing patterns
- **File Handling**: Follow existing patterns for file operations and downloads
- **Error Handling**: Use existing error handling patterns from tRPC and React
- **TypeScript**: Maintain strict typing throughout all new code
- **Security**: Ensure PDF generation doesn't expose sensitive data, validate all inputs

### Project Structure Notes
The story aligns perfectly with the existing project structure. The Reports page exists and is ready for PDF generation integration. The tRPC pattern should be followed instead of traditional API routes to maintain consistency with the existing codebase architecture.

**Key Integration Points:**
- BusinessProfile model is already implemented and accessible via tRPC
- Reports page UI foundation is complete from Story 3.3
- Existing data models (Sales, Repairs) are available for querying
- Testing and UI patterns are well-established

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-24 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Fixed async PDF creation with proper initialization pattern
- Resolved database model field name mismatches (Customer.name vs firstName/lastName)
- Corrected SaleItem field mapping (priceAtTime vs unitPrice)
- Updated Repair model field usage (totalCost vs repairCost, partsCost vs calculated)

### Completion Notes List
- Successfully implemented complete PDF generation infrastructure using pdf-lib
- Created professional PDF reports with business branding and proper formatting
- Implemented comprehensive error handling and user feedback
- All acceptance criteria fully met and tested
- Build passes successfully with TypeScript strict mode

### File List
**New Files Created:**
- `/src/lib/pdf-generator.ts` - PDF generation utility classes and functions
- `/src/server/api/routers/reports.ts` - tRPC procedures for report generation
- `/src/lib/pdf-generator.test.ts` - Unit tests for PDF generation logic
- `/src/server/api/routers/reports.test.ts` - Integration tests for tRPC procedures

**Files Modified:**
- `/src/server/api/root.ts` - Added reports router to main tRPC router
- `/src/app/(main)/reports/page.tsx` - Enabled PDF generation functionality with UI
- `/src/app/(main)/reports/page.test.tsx` - Updated component tests for PDF features
- `/package.json` - Added pdf-lib@^1.17.1 dependency

## QA Results
*Results from QA Agent review will be populated here after implementation*