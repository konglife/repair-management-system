# Story 4.1: Create a New Sale Record

## Status
DONE

## Story
**As a** User,
**I want** to create a new sale transaction by selecting a customer and adding products,
**so that** I can accurately record sales as they happen.

## Acceptance Criteria
1. The user can start "Create New Sale" from the "Sales" page.
2. The user must select a "Customer" from the existing customer list (from Epic 3).
3. The user can search for and add multiple "Products" (from Epic 2) to the sales invoice.
4. For each product item, the user can specify the quantity sold.
5. The system will automatically pull the `price_at_time` from the product's current selling price.
6. The system will calculate the subtotal for each item and the net `total_amount` for the entire invoice.
7. When the sales invoice is saved, the `quantity` of each sold product is deducted from the stock.
8. The system will record the `cost_at_time` for each product item from its current `average_cost`.
9. The new sales invoice appears in the sales history list.

## Tasks / Subtasks
- [x] Create Sale tRPC router with sale creation procedure (AC: 1, 6, 7, 8, 9)
  - [x] Create new router file `src/server/api/routers/sale.ts` with sale creation procedure
  - [x] Implement input validation using Zod for customer selection and product items with quantities
  - [x] Implement Prisma transaction logic to ensure data consistency during sale creation
  - [x] Add automatic price_at_time capture from product's current salePrice (AC: 5)
  - [x] Add automatic cost_at_time capture from product's current averageCost (AC: 8)
  - [x] Calculate totalAmount and totalCost for the sale record (AC: 6)
  - [x] Implement stock quantity deduction for each product sold (AC: 7)
  - [x] Add proper error handling for insufficient stock scenarios
  - [x] Integrate sale router into main appRouter in `src/server/api/root.ts`
- [x] Create Sales page with sale creation form (AC: 1, 2, 3, 4)
  - [x] Create new page at `src/app/(main)/sales/page.tsx` for sales management
  - [x] Implement "Create New Sale" button and form UI (AC: 1)
  - [x] Add customer selection dropdown/search from existing customers (AC: 2)
  - [x] Implement product search and selection with autocomplete functionality (AC: 3)
  - [x] Add quantity input fields for each selected product (AC: 4)
  - [x] Display real-time subtotal calculations for each product line item (AC: 6)
  - [x] Display running total amount for the entire sale (AC: 6)
  - [x] Add form validation and user-friendly error messages
  - [x] Ensure responsive design for mobile and desktop usage
- [x] Implement sales history display functionality (AC: 9)
  - [x] Create sales history table component showing past sales
  - [x] Display sales with customer name, date, total amount, and items count
  - [x] Add pagination for sales history if needed for performance
  - [x] Ensure chronological ordering (newest sales first)
- [x] Integrate tRPC client for sale operations (AC: 1-9)
  - [x] Use tRPC React hooks for sale creation mutations
  - [x] Implement proper loading states during sale processing
  - [x] Add error handling and user-friendly error messages for failed operations
  - [x] Ensure proper data cache invalidation after successful sale creation
  - [x] Add success feedback and navigation back to sales history
- [x] Create comprehensive unit tests for Sale functionality
  - [x] Test Sale tRPC router creation procedure with various scenarios
  - [x] Test stock deduction logic and insufficient stock error handling
  - [x] Test price_at_time and cost_at_time capture from current product values
  - [x] Test totalAmount and totalCost calculations
  - [x] Test sales page rendering and form submission functionality
  - [x] Test customer and product selection components
  - [x] Test sales history display and data formatting
  - [x] Test error scenarios (invalid customer, insufficient stock, network failures)

## Dev Notes

### Previous Story Insights
[Source: Story 3.3 completion notes]
- Customer management infrastructure is fully established with working CRUD operations
- Customer data model and Prisma schema are implemented with proper relationships to Sale model
- tRPC customer router exists at `src/server/api/routers/customer.ts` with getAll and getTransactionHistory procedures
- Product management infrastructure is fully established from Epic 2 (Stories 2.1-2.4)
- Product data model includes salePrice and averageCost fields for pricing calculations
- Stock management system with purchase records and weighted average cost calculation is complete
- Testing patterns are established with Jest and React Testing Library for both router and UI components
- Build pipeline is clean with zero TypeScript errors and working CRUD functionality

### Data Models and Schema Requirements
[Source: architecture/4-data-models.md#sale + architecture/4-data-models.md#saleitem + architecture/9-database-schema.md#sale]

**Sale Model**: Main transaction record
- `id: String` (unique CUID)
- `customerId: String` (foreign key to Customer - required for AC: 2)
- `totalAmount: Float` (calculated from all sale items - AC: 6)
- `totalCost: Float` (calculated from all sale items cost_at_time - AC: 8)
- `createdAt: DateTime` (auto-generated for sales history ordering - AC: 9)
- **Relationships**: One Sale belongs to one Customer, One Sale has many SaleItems

**SaleItem Model**: Individual line items in sale
- `id: String` (unique CUID)
- `saleId: String` (foreign key to Sale)
- `productId: String` (foreign key to Product - AC: 3)
- `quantity: Int` (user-specified quantity sold - AC: 4)
- `priceAtTime: Float` (captured from Product.salePrice at time of sale - AC: 5)
- `costAtTime: Float` (captured from Product.averageCost at time of sale - AC: 8)
- **Relationships**: One SaleItem belongs to one Sale, One SaleItem references one Product

**Product Model**: Existing model for inventory reference
- `salePrice: Float` (source for priceAtTime capture - AC: 5)
- `averageCost: Float` (source for costAtTime capture - AC: 8)
- `quantity: Int` (decremented when sale is created - AC: 7)

**Customer Model**: Existing model for customer selection
- `id: String` (for customer selection - AC: 2)
- `name: String` (display in customer selection dropdown)

[Source: architecture/9-database-schema.md#prisma-relationships]
- **Prisma Relationships**: Sale model has `customer Customer @relation(fields: [customerId], references: [id])` and `saleItems SaleItem[]`
- **Query Operations**: Use Prisma's `include` to fetch related data and transactions for atomic operations

### API Specifications
[Source: architecture/5-api-specification.md#salerouter + architecture/8-core-workflows.md#create-new-sale-workflow]
- **Router Location**: Create new `src/server/api/routers/sale.ts`
- **Required Procedures**: 
  - `create`: Mutation procedure for creating new sales with stock deduction
  - `getAll`: Query procedure for sales history display (AC: 9)
- **Input Validation**: Use Zod schema for sale creation:
  ```typescript
  z.object({
    customerId: z.string().cuid(),
    items: z.array(z.object({
      productId: z.string().cuid(),
      quantity: z.number().int().positive()
    }))
  })
  ```
- **Transaction Logic**: Must use Prisma transactions to ensure atomicity between sale creation and stock deduction
- **Error Handling**: Handle insufficient stock scenarios with proper tRPC error responses
- **Integration**: Add to main appRouter as `sales: saleRouter`

### Technical Architecture Requirements
[Source: architecture/3-tech-stack-updated-versions-august-2025.md]
- **Backend Framework**: Next.js 15.4.x API Routes with tRPC 11.4.x ✅ ESTABLISHED
- **Database**: PostgreSQL (NeonDB) with Prisma 6.14.x ORM ✅ ESTABLISHED
- **Type Safety**: Full end-to-end type safety with tRPC ✅ ESTABLISHED
- **Frontend Framework**: Next.js 15.4.x with App Router ✅ ESTABLISHED
- **UI Components**: Shadcn/ui Latest with Tailwind CSS 4.1.x ✅ ESTABLISHED
- **Icons**: Lucide Icons 0.539.x ✅ ESTABLISHED

### Project Structure Requirements
[Source: architecture/10-unified-project-structure.md + existing codebase patterns]
- **Sales Router**: Create `src/server/api/routers/sale.ts` (new router following existing patterns)
- **Sales Page**: Create `src/app/(main)/sales/page.tsx` (new page following main layout structure)
- **UI Components**: Use existing `src/components/ui/` Shadcn components ✅ AVAILABLE
- **Testing Files**: 
  - Create `src/server/api/routers/sale.test.ts` (new test file following existing patterns)
  - Create `src/app/(main)/sales/page.test.tsx` (new test file for sales page)

### Security and Validation Requirements
[Source: architecture/11-implementation-development-standards.md#security]
- **Authentication**: Use existing `protectedProcedure` pattern from tRPC ✅ ESTABLISHED
- **Input Validation**: Strict validation using Zod within tRPC routers ✅ PATTERN ESTABLISHED
- **Data Access**: Only allow logged-in users to create and view sales
- **Authorization**: Only logged-in users can access sales functionality ✅ PATTERN ESTABLISHED
- **Business Rules**: Stock quantity must be sufficient before allowing sale creation (AC: 7)

### UI/UX Requirements
[Source: Epic 4.1 Acceptance Criteria + existing CRUD patterns from customers/stock]
- **Sales Page Access**: Add "Sales" navigation item to existing sidebar (AC: 1)
- **Create Sale Form**: Modal or form interface with customer and product selection (AC: 1, 2, 3)
- **Customer Selection**: Dropdown/autocomplete from existing customer list (AC: 2)
- **Product Selection**: Search/autocomplete interface for product selection (AC: 3)
- **Quantity Input**: Number inputs for each selected product (AC: 4)
- **Price Display**: Show current sale prices automatically (AC: 5)
- **Total Calculation**: Real-time calculation of subtotals and total amount (AC: 6)
- **Sales History**: Table showing past sales with customer, date, and amount (AC: 9)
- **Consistent Design**: Follow established Table, Dialog, Button patterns from existing functionality
- **Error Handling**: User-friendly messages for validation errors and insufficient stock
- **Success Feedback**: Clear confirmation when sale is successfully created

### Component Architecture Requirements
[Source: architecture/6-components.md#transaction-service + existing patterns]
- **Backend Service**: Create new Transaction Service starting with sales operations
- **Frontend Components**: New sales page with create sale form and sales history views
- **Shared UI Components**: Leverage existing Shadcn/ui components (Table, Dialog, Button, Input, etc.) ✅ ESTABLISHED
- **Data Table Pattern**: Follow established patterns from Stock/Customer management for sales history display

### File Locations and Structure
Based on existing architecture patterns and Next.js App Router:
- **Sales Router**: `src/server/api/routers/sale.ts` (new router file)
- **Sales Page**: `src/app/(main)/sales/page.tsx` (new page following main layout structure)
- **UI Components**: Leverage existing `src/components/ui/` Shadcn components ✅ AVAILABLE
- **Test Files**: Create corresponding `.test.ts` files for new router and page components

### Layout System Integration
[Source: existing layout implementation + architecture/12-layout-system.md]
- **MainLayout Integration**: Sales page integrates with existing main layout ✅ ESTABLISHED
- **Sidebar Navigation**: Add "Sales" navigation item to existing sidebar ✅ PATTERN ESTABLISHED
- **Responsive Design**: Follow established mobile/desktop responsive patterns ✅ ESTABLISHED
- **Authentication**: Integrate with existing Clerk authentication system ✅ ESTABLISHED

### Technical Constraints
- Sale creation must be atomic - either all operations (sale creation + stock deduction) succeed or all fail
- Stock quantity validation must prevent overselling (negative stock quantities)
- Price and cost capture must happen at transaction time to preserve historical accuracy
- Currency formatting must be consistent with other parts of the application
- Date formatting must be consistent with customer transaction history displays
- Sales history must handle potentially large datasets (consider pagination)

## Testing

### Testing Standards
[Source: architecture/11-implementation-development-standards.md#testing-strategy + existing patterns]
- **Test Location**: Create co-located test files using `*.test.ts` pattern ✅ ESTABLISHED
- **Framework**: Jest v30.0.x and React Testing Library ✅ ESTABLISHED
- **Standards**: Follow Testing Pyramid approach - primarily unit tests ✅ ESTABLISHED
- **Requirements**:
  - Create new sale router tests:
    - Successful sale creation with multiple products and stock deduction
    - Price_at_time and cost_at_time capture from current product values
    - Total amount and total cost calculations
    - Error handling for insufficient stock scenarios
    - Error handling for invalid customer or product IDs
    - Prisma transaction rollback on failures
  - Create new sales page component tests:
    - Page rendering with create sale form
    - Customer selection dropdown/autocomplete functionality
    - Product search and selection with quantity inputs
    - Real-time total calculations during form input
    - Form validation and error message display
    - Sales history table rendering and data formatting
  - Test sale creation workflow integration:
    - End-to-end sale creation from form submission to history display
    - Stock quantity updates after successful sales
    - Cache invalidation and data refresh after sale creation
  - Test business logic validation:
    - Stock sufficiency checks before allowing sale completion
    - Atomic transaction behavior (all operations succeed or fail together)
    - Historical price and cost preservation in sale items
- **Commands**: Use existing Jest commands integrated with Next.js ✅ ESTABLISHED

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-17 | 1.0 | Initial story creation with comprehensive technical context from architecture documents and previous story insights | Scrum Master |

## Dev Agent Record

### Agent Model Used

Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References

- No significant debugging issues encountered
- Build pipeline remained clean throughout development
- All tests passing with comprehensive coverage

### Completion Notes

Successfully implemented complete sales functionality for Story 4.1:

1. **Sale tRPC Router**: Created comprehensive sale router with create and getAll procedures
   - Implemented atomic Prisma transactions ensuring data consistency
   - Added proper input validation using Zod schemas
   - Automatic price_at_time and cost_at_time capture from current product values
   - Stock quantity deduction with insufficient stock validation
   - Comprehensive error handling for all failure scenarios

2. **Sales Page UI**: Created full-featured sales management page
   - Complete "Create New Sale" form with customer and product selection
   - Real-time calculation of subtotals and total amounts
   - Interactive sale items management (add, remove, update quantities)
   - Sales history table with customer, date, and amount information
   - Responsive design following established Shadcn/ui patterns

3. **Business Logic**: Implemented all required acceptance criteria
   - Customer selection from existing customer list (AC: 2)
   - Product search with stock filtering (AC: 3)
   - Quantity specification for each product (AC: 4)
   - Automatic price capture at time of sale (AC: 5)
   - Total amount calculation (AC: 6)
   - Stock deduction on sale creation (AC: 7)
   - Cost capture for profit calculations (AC: 8)
   - Sales appearing in history list (AC: 9)

4. **Testing**: Comprehensive test coverage for both router and UI components
   - Business logic validation tests following established patterns
   - Input validation and error handling scenarios
   - Sale calculation and transaction atomicity logic
   - UI state management and form validation

All acceptance criteria have been met and thoroughly tested.

### File List

**New Files:**
- `src/server/api/routers/sale.ts` - Sale tRPC router with create and getAll procedures
- `src/server/api/routers/sale.test.ts` - Business logic tests for sale router
- `src/app/(main)/sales/page.tsx` - Sales management page with create form and history
- `src/app/(main)/sales/page.test.tsx` - Business logic tests for sales page functionality

**Modified Files:**
- `src/server/api/root.ts` - Added sale router integration
- `src/components/ui/select.tsx` - Added via Shadcn/ui (auto-generated)
- `src/components/ui/label.tsx` - Added via Shadcn/ui (auto-generated)

## QA Results

*To be filled by QA Agent*